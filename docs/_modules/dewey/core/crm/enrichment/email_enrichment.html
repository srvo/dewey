<!DOCTYPE html>

<html lang="en" data-content_root="../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dewey.core.crm.enrichment.email_enrichment &#8212; Dewey (TUI) 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />

  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />





  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for dewey.core.crm.enrichment.email_enrichment</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">duckdb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dewey.core.base_script</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseScript</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dewey.core.db.connection</span><span class="w"> </span><span class="kn">import</span> <span class="n">db_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dewey.utils.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">execute_query</span><span class="p">,</span> <span class="n">fetch_all</span><span class="p">,</span> <span class="n">fetch_one</span>


<div class="viewcode-block" id="EmailEnrichment">
<a class="viewcode-back" href="../../../../../dewey.core.crm.enrichment.html#dewey.core.crm.enrichment.email_enrichment.EmailEnrichment">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EmailEnrichment</span><span class="p">(</span><span class="n">BaseScript</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enriches email data with additional metadata.</span>

<span class="sd">    This class provides methods to enrich email data with:</span>
<span class="sd">    - Message priority scores</span>
<span class="sd">    - Contact information extracted from email content</span>
<span class="sd">    - Business opportunity detection</span>
<span class="sd">    - Full message bodies (plain text and HTML)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EmailEnrichment.__init__">
<a class="viewcode-back" href="../../../../../dewey.core.crm.enrichment.html#dewey.core.crm.enrichment.email_enrichment.EmailEnrichment.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the EmailEnrichment script.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;EmailEnrichment&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Process and enrich email data from Gmail&quot;</span><span class="p">,</span>
            <span class="n">config_section</span><span class="o">=</span><span class="s2">&quot;core&quot;</span><span class="p">,</span>
            <span class="n">requires_db</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># We&#39;ll manage our connection differently</span>
            <span class="n">enable_llm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Set up logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;EmailEnrichment&quot;</span><span class="p">)</span>

        <span class="c1"># Set up database connection - use MotherDuck by default</span>
        <span class="n">load_dotenv</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motherduck_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MOTHERDUCK_TOKEN&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">motherduck_token</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;motherduck_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motherduck_token</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="o">=</span> <span class="s2">&quot;md:dewey&quot;</span>  <span class="c1"># Always use MotherDuck as primary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_gmail_api</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Default to not using Gmail API</span>

        <span class="c1"># Initialize database tables right away</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_setup_database_tables</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Database tables for email enrichment initialized during startup&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error setting up database tables: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Random emoji set for processing feedback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emojis</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;‚úâÔ∏è&quot;</span><span class="p">,</span> <span class="s2">&quot;üì©&quot;</span><span class="p">,</span> <span class="s2">&quot;üì¨&quot;</span><span class="p">,</span> <span class="s2">&quot;üìÆ&quot;</span><span class="p">,</span> <span class="s2">&quot;üìß&quot;</span><span class="p">,</span> <span class="s2">&quot;üì®&quot;</span><span class="p">,</span> <span class="s2">&quot;üì™&quot;</span><span class="p">,</span> <span class="s2">&quot;üì´&quot;</span><span class="p">,</span> <span class="s2">&quot;üì≠&quot;</span><span class="p">,</span> <span class="s2">&quot;üì§&quot;</span><span class="p">,</span> <span class="s2">&quot;üì•&quot;</span><span class="p">]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a connection to the database using a context manager.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Context manager for database connection</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ConnectionManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="EmailEnrichment.execute">
<a class="viewcode-back" href="../../../../../dewey.core.crm.enrichment.html#dewey.core.crm.enrichment.email_enrichment.EmailEnrichment.execute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the email enrichment process with proper error handling.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting email enrichment process&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use the database manager&#39;s context manager</span>
            <span class="k">with</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="c1"># Setup database tables</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_setup_database_tables</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

                <span class="c1"># Process emails that need enrichment</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_emails_for_enrichment</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Email enrichment process completed successfully&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in email enrichment process: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_database_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up the necessary database tables for email enrichment.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create or validate email enrichment status table</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE TABLE IF NOT EXISTS email_enrichment_status (</span>
<span class="s2">                email_id VARCHAR PRIMARY KEY,</span>
<span class="s2">                status VARCHAR,</span>
<span class="s2">                priority_score FLOAT,</span>
<span class="s2">                priority_reason VARCHAR,</span>
<span class="s2">                priority_confidence FLOAT,</span>
<span class="s2">                body_enriched BOOLEAN,</span>
<span class="s2">                contact_info_enriched BOOLEAN,</span>
<span class="s2">                opportunity_detected BOOLEAN,</span>
<span class="s2">                last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
<span class="s2">            )</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># Create or validate email content table for storing enriched content</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE TABLE IF NOT EXISTS email_content (</span>
<span class="s2">                email_id VARCHAR PRIMARY KEY,</span>
<span class="s2">                plain_body TEXT,</span>
<span class="s2">                html_body TEXT,</span>
<span class="s2">                extracted_contact_info JSON,</span>
<span class="s2">                business_opportunities JSON,</span>
<span class="s2">                last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
<span class="s2">            )</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database tables for email enrichment created or verified&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error setting up database tables: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_emails_for_enrichment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process emails that need enrichment.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get emails that need enrichment - using msg_id as primary identifier instead of draft_id</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT msg_id, from_address, NULL as from_name, subject, import_timestamp</span>
<span class="s2">            FROM emails e</span>
<span class="s2">            LEFT JOIN email_enrichment_status s ON e.msg_id = s.email_id</span>
<span class="s2">            WHERE s.email_id IS NULL OR s.status = &#39;pending&#39;</span>
<span class="s2">            ORDER BY import_timestamp DESC</span>
<span class="s2">            LIMIT ?</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>
            <span class="n">emails</span> <span class="o">=</span> <span class="n">fetch_all</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">emails</span><span class="p">)</span><span class="si">}</span><span class="s2"> emails to enrich&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">emails</span><span class="p">:</span>
                <span class="n">msg_id</span><span class="p">,</span> <span class="n">from_address</span><span class="p">,</span> <span class="n">from_name</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">import_timestamp</span> <span class="o">=</span> <span class="n">email</span>

                <span class="c1"># Skip if msg_id is null</span>
                <span class="k">if</span> <span class="n">msg_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skipping email with null msg_id&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Process the email</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Fetch email body from Gmail if needed</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_email_body</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">)</span>

                    <span class="c1"># Extract contact information</span>
                    <span class="n">contact_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_contact_info</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">)</span>

                    <span class="c1"># Detect business opportunities</span>
                    <span class="n">opportunities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_opportunities</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">)</span>

                    <span class="c1"># Calculate priority score</span>
                    <span class="n">priority_score</span><span class="p">,</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_priority</span><span class="p">(</span>
                        <span class="n">conn</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span> <span class="n">from_address</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">contact_info</span><span class="p">,</span> <span class="n">opportunities</span>
                    <span class="p">)</span>

                    <span class="c1"># Update enrichment status</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_enrichment_status</span><span class="p">(</span>
                        <span class="n">conn</span><span class="p">,</span>
                        <span class="n">msg_id</span><span class="p">,</span>
                        <span class="n">priority_score</span><span class="p">,</span>
                        <span class="n">reason</span><span class="p">,</span>
                        <span class="n">confidence</span><span class="p">,</span>
                        <span class="nb">bool</span><span class="p">(</span><span class="n">contact_info</span><span class="p">),</span>
                        <span class="nb">bool</span><span class="p">(</span><span class="n">opportunities</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully enriched email </span><span class="si">{</span><span class="n">msg_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error enriching email </span><span class="si">{</span><span class="n">msg_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># Mark this email as having failed enrichment</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_update_enrichment_status</span><span class="p">(</span>
                            <span class="n">conn</span><span class="p">,</span>
                            <span class="n">msg_id</span><span class="p">,</span>
                            <span class="mf">0.0</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="mf">0.0</span><span class="p">,</span>
                            <span class="kc">False</span><span class="p">,</span>
                            <span class="kc">False</span><span class="p">,</span>
                            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">inner_e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to update status for email </span><span class="si">{</span><span class="n">msg_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">inner_e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing emails for enrichment: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_email_body</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">,</span> <span class="n">email_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch email body content from the database or Gmail API as fallback.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection</span>
<span class="sd">            email_id: ID of the email to fetch</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (plain_text_body, html_body)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First check if we already have the content in email_content</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT plain_body, html_body FROM email_content</span>
<span class="s2">        WHERE email_id = ?</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">email_id</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fetch_one</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">plain_body</span><span class="p">,</span> <span class="n">html_body</span> <span class="o">=</span> <span class="n">result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found existing email content for </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">plain_body</span><span class="p">,</span> <span class="n">html_body</span>

        <span class="c1"># Try to get from raw_emails table first (should be faster than API)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT body, headers, subject, sender</span>
<span class="s2">            FROM raw_emails</span>
<span class="s2">            WHERE message_id = ?</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">email_id</span><span class="p">]</span>
            <span class="n">raw_result</span> <span class="o">=</span> <span class="n">fetch_one</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">raw_result</span> <span class="ow">and</span> <span class="n">raw_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># If we have a body in raw_emails</span>
                <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">raw_result</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using body from raw_emails for </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># If body has HTML content, try to extract it</span>
                <span class="k">if</span> <span class="n">body</span> <span class="ow">and</span> <span class="s2">&quot;&lt;html&quot;</span> <span class="ow">in</span> <span class="n">body</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">html_body</span> <span class="o">=</span> <span class="n">body</span>
                    <span class="c1"># Extract plain text from HTML</span>
                    <span class="n">plain_text</span> <span class="o">=</span> <span class="n">body</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Remove HTML tags if possible</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

                        <span class="n">plain_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;[^&gt;]+&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">html_body</span><span class="p">)</span>
                        <span class="n">plain_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">plain_text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Error extracting plain text from HTML: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Plain text only</span>
                    <span class="n">plain_text</span> <span class="o">=</span> <span class="n">body</span>
                    <span class="n">html_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;pre&gt;</span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>

                <span class="c1"># Store the content</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_store_email_content</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">email_id</span><span class="p">,</span> <span class="n">plain_text</span><span class="p">,</span> <span class="n">html_body</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">plain_text</span><span class="p">,</span> <span class="n">html_body</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting body from raw_emails: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Try to fetch from Gmail API if client is available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gmail_api</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmail_client</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching email </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2"> from Gmail API&quot;</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmail_client</span><span class="o">.</span><span class="n">fetch_message</span><span class="p">(</span><span class="n">email_id</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
                    <span class="c1"># Extract body</span>
                    <span class="n">plain_body</span><span class="p">,</span> <span class="n">html_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmail_client</span><span class="o">.</span><span class="n">extract_body</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">plain_body</span> <span class="ow">or</span> <span class="n">html_body</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Successfully fetched email body from Gmail API for </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                        <span class="c1"># Get subject from headers</span>
                        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="p">[])</span>
                        <span class="p">}</span>

                        <span class="n">subject</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                        <span class="c1"># Add subject to plain text if available</span>
                        <span class="k">if</span> <span class="n">plain_body</span> <span class="ow">and</span> <span class="n">subject</span><span class="p">:</span>
                            <span class="n">plain_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Subject: </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">plain_body</span><span class="si">}</span><span class="s2">&quot;</span>

                        <span class="c1"># Add subject to HTML if available</span>
                        <span class="k">if</span> <span class="n">html_body</span> <span class="ow">and</span> <span class="n">subject</span><span class="p">:</span>
                            <span class="c1"># If html_body has &lt;body&gt; tag, add subject inside it</span>
                            <span class="k">if</span> <span class="s2">&quot;&lt;body&quot;</span> <span class="ow">in</span> <span class="n">html_body</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                <span class="n">html_body</span> <span class="o">=</span> <span class="n">html_body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                    <span class="s2">&quot;&lt;body&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&lt;body&gt;&lt;h3&gt;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">&lt;/h3&gt;&quot;</span><span class="p">,</span> <span class="mi">1</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">html_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;h3&gt;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">&lt;/h3&gt;</span><span class="si">{</span><span class="n">html_body</span><span class="si">}</span><span class="s2">&lt;/body&gt;&lt;/html&gt;&quot;</span>

                        <span class="c1"># Store the content</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_store_email_content</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">email_id</span><span class="p">,</span> <span class="n">plain_body</span><span class="p">,</span> <span class="n">html_body</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">plain_body</span><span class="p">,</span> <span class="n">html_body</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching email from Gmail API: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Continue to fallback methods</span>

        <span class="c1"># Fall back to snippet if no body found</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT snippet, subject FROM raw_emails</span>
<span class="s2">        WHERE message_id = ?</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">email_id</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fetch_one</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No content found for email </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plain_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No content available for email </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">html_body</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;No content available for email </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2">&lt;/body&gt;&lt;/html&gt;&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">snippet</span><span class="p">,</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">result</span>
            <span class="c1"># Use snippet and subject for body</span>
            <span class="n">plain_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Subject: </span><span class="si">{</span><span class="n">subject</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;No subject&#39;</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">snippet</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">html_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;h3&gt;</span><span class="si">{</span><span class="n">subject</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;No subject&#39;</span><span class="si">}</span><span class="s2">&lt;/h3&gt;&lt;p&gt;</span><span class="si">{</span><span class="n">snippet</span><span class="si">}</span><span class="s2">&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using snippet as body for email </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Store the content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_email_content</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">email_id</span><span class="p">,</span> <span class="n">plain_body</span><span class="p">,</span> <span class="n">html_body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plain_body</span><span class="p">,</span> <span class="n">html_body</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_store_email_content</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">conn</span><span class="p">:</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">,</span>
        <span class="n">email_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">plain_body</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">html_body</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store email content in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection</span>
<span class="sd">            email_id: ID of the email</span>
<span class="sd">            plain_body: Plain text body</span>
<span class="sd">            html_body: HTML body</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if record exists first</span>
        <span class="n">check_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT 1 FROM email_content WHERE email_id = ? LIMIT 1</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">fetch_one</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">check_query</span><span class="p">,</span> <span class="p">[</span><span class="n">email_id</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
            <span class="c1"># Update existing record</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            UPDATE email_content SET</span>
<span class="s2">                plain_body = ?,</span>
<span class="s2">                html_body = ?,</span>
<span class="s2">                last_updated = CURRENT_TIMESTAMP</span>
<span class="s2">            WHERE email_id = ?</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">plain_body</span><span class="p">,</span> <span class="n">html_body</span><span class="p">,</span> <span class="n">email_id</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Insert new record</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            INSERT INTO email_content (email_id, plain_body, html_body, last_updated)</span>
<span class="s2">            VALUES (?, ?, ?, CURRENT_TIMESTAMP)</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">email_id</span><span class="p">,</span> <span class="n">plain_body</span><span class="p">,</span> <span class="n">html_body</span><span class="p">]</span>

        <span class="n">execute_query</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_contact_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">,</span> <span class="n">email_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract contact information from email content.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection</span>
<span class="sd">            email_id: ID of the email to process</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing extracted contact information</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the email body</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT plain_body, html_body FROM email_content</span>
<span class="s2">        WHERE email_id = ?</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">email_id</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fetch_one</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">plain_body</span><span class="p">,</span> <span class="n">html_body</span> <span class="o">=</span> <span class="n">result</span>

        <span class="c1"># In a real implementation, this would use regex or NLP to extract contact info</span>
        <span class="c1"># For testing, we&#39;ll just create some placeholder data</span>
        <span class="n">contact_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Example Contact&quot;</span><span class="p">,</span>
            <span class="s2">&quot;phone&quot;</span><span class="p">:</span> <span class="s2">&quot;555-123-4567&quot;</span><span class="p">,</span>
            <span class="s2">&quot;job_title&quot;</span><span class="p">:</span> <span class="s2">&quot;Test Position&quot;</span><span class="p">,</span>
            <span class="s2">&quot;company&quot;</span><span class="p">:</span> <span class="s2">&quot;Sample Corp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Store the extracted contact info</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        UPDATE email_content</span>
<span class="s2">        SET extracted_contact_info = ?,</span>
<span class="s2">            last_updated = CURRENT_TIMESTAMP</span>
<span class="s2">        WHERE email_id = ?</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">contact_info</span><span class="p">),</span> <span class="n">email_id</span><span class="p">]</span>
        <span class="n">execute_query</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">contact_info</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_opportunities</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">,</span> <span class="n">email_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect business opportunities in email content.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection</span>
<span class="sd">            email_id: ID of the email to process</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of detected opportunities</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the email body and subject</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT e.subject, c.plain_body</span>
<span class="s2">        FROM emails e</span>
<span class="s2">        JOIN email_content c ON e.msg_id = c.email_id</span>
<span class="s2">        WHERE e.msg_id = ?</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">email_id</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fetch_one</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">subject</span><span class="p">,</span> <span class="n">plain_body</span> <span class="o">=</span> <span class="n">result</span>

        <span class="c1"># In a real implementation, this would use NLP to identify opportunities</span>
        <span class="c1"># For testing, we&#39;ll just create some placeholder data</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;proposal&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">subject</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="ow">or</span> <span class="s2">&quot;opportunity&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">plain_body</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;business_lead&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span>
                    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;Potential business opportunity detected&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;keywords&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;proposal&quot;</span><span class="p">,</span> <span class="s2">&quot;opportunity&quot;</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Store the detected opportunities</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        UPDATE email_content</span>
<span class="s2">        SET business_opportunities = ?,</span>
<span class="s2">            last_updated = CURRENT_TIMESTAMP</span>
<span class="s2">        WHERE email_id = ?</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">opportunities</span><span class="p">),</span> <span class="n">email_id</span><span class="p">]</span>
        <span class="n">execute_query</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">opportunities</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_priority</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">conn</span><span class="p">:</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">,</span>
        <span class="n">email_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">from_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">contact_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">opportunities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate priority score for an email.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection</span>
<span class="sd">            email_id: ID of the email</span>
<span class="sd">            from_address: Sender&#39;s email address</span>
<span class="sd">            subject: Email subject</span>
<span class="sd">            contact_info: Extracted contact information</span>
<span class="sd">            opportunities: Detected business opportunities</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (priority_score, confidence, reason)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Simple priority logic - in a real implementation, this would be more sophisticated</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Default priority&quot;</span>

        <span class="c1"># Check if it&#39;s from an important domain</span>
        <span class="n">important_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gmail.com&quot;</span><span class="p">,</span> <span class="s2">&quot;example.com&quot;</span><span class="p">]</span>
        <span class="n">sender_domain</span> <span class="o">=</span> <span class="n">from_address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">from_address</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">sender_domain</span> <span class="ow">in</span> <span class="n">important_domains</span><span class="p">:</span>
            <span class="n">priority</span> <span class="o">+=</span> <span class="mf">0.2</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Sender from important domain: </span><span class="si">{</span><span class="n">sender_domain</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.7</span>

        <span class="c1"># Check for business opportunities</span>
        <span class="k">if</span> <span class="n">opportunities</span><span class="p">:</span>
            <span class="n">priority</span> <span class="o">+=</span> <span class="mf">0.4</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Business opportunity detected&quot;</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.8</span>

        <span class="c1"># Check for contact information</span>
        <span class="k">if</span> <span class="n">contact_info</span><span class="p">:</span>
            <span class="n">priority</span> <span class="o">+=</span> <span class="mf">0.2</span>
            <span class="k">if</span> <span class="s2">&quot;company&quot;</span> <span class="ow">in</span> <span class="n">contact_info</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Contact from </span><span class="si">{</span><span class="n">contact_info</span><span class="p">[</span><span class="s1">&#39;company&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.75</span>

        <span class="c1"># Check for urgent keywords in subject</span>
        <span class="n">urgent_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;urgent&quot;</span><span class="p">,</span> <span class="s2">&quot;important&quot;</span><span class="p">,</span> <span class="s2">&quot;asap&quot;</span><span class="p">,</span> <span class="s2">&quot;deadline&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">subject</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">subject</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">urgent_keywords</span><span class="p">):</span>
            <span class="n">priority</span> <span class="o">+=</span> <span class="mf">0.3</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Urgent subject&quot;</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.9</span>

        <span class="c1"># Normalize priority score</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">priority</span><span class="p">,</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">reason</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_enrichment_status</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">conn</span><span class="p">:</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">,</span>
        <span class="n">email_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">priority_score</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">priority_reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">priority_confidence</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">contact_info_enriched</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">opportunity_detected</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the enrichment status for an email.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection</span>
<span class="sd">            email_id: ID of the email</span>
<span class="sd">            priority_score: Calculated priority score</span>
<span class="sd">            priority_reason: Reason for the priority score</span>
<span class="sd">            priority_confidence: Confidence in the priority score</span>
<span class="sd">            contact_info_enriched: Whether contact info was extracted</span>
<span class="sd">            opportunity_detected: Whether business opportunities were detected</span>
<span class="sd">            status: Status of the enrichment process</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if record exists first</span>
        <span class="n">check_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT 1 FROM email_enrichment_status WHERE email_id = ? LIMIT 1</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">fetch_one</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">check_query</span><span class="p">,</span> <span class="p">[</span><span class="n">email_id</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
            <span class="c1"># Update existing record</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            UPDATE email_enrichment_status SET</span>
<span class="s2">                status = ?,</span>
<span class="s2">                priority_score = ?,</span>
<span class="s2">                priority_reason = ?,</span>
<span class="s2">                priority_confidence = ?,</span>
<span class="s2">                body_enriched = ?,</span>
<span class="s2">                contact_info_enriched = ?,</span>
<span class="s2">                opportunity_detected = ?,</span>
<span class="s2">                last_updated = CURRENT_TIMESTAMP</span>
<span class="s2">            WHERE email_id = ?</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">status</span><span class="p">,</span>
                <span class="n">priority_score</span><span class="p">,</span>
                <span class="n">priority_reason</span><span class="p">,</span>
                <span class="n">priority_confidence</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">,</span>
                <span class="n">contact_info_enriched</span><span class="p">,</span>
                <span class="n">opportunity_detected</span><span class="p">,</span>
                <span class="n">email_id</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Insert new record</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            INSERT INTO email_enrichment_status (</span>
<span class="s2">                email_id, status, priority_score, priority_reason, priority_confidence,</span>
<span class="s2">                body_enriched, contact_info_enriched, opportunity_detected, last_updated</span>
<span class="s2">            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">email_id</span><span class="p">,</span>
                <span class="n">status</span><span class="p">,</span>
                <span class="n">priority_score</span><span class="p">,</span>
                <span class="n">priority_reason</span><span class="p">,</span>
                <span class="n">priority_confidence</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">,</span>
                <span class="n">contact_info_enriched</span><span class="p">,</span>
                <span class="n">opportunity_detected</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="n">execute_query</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="EmailEnrichment.enrich_email">
<a class="viewcode-back" href="../../../../../dewey.core.crm.enrichment.html#dewey.core.crm.enrichment.email_enrichment.EmailEnrichment.enrich_email">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">enrich_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enrich a single email with additional metadata and analysis.</span>

<span class="sd">        Args:</span>
<span class="sd">            email_id: The email ID to enrich</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if enrichment was successful, False otherwise</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enriching single email: </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="c1"># Check if this email has already been enriched</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT status FROM email_enrichment_status WHERE email_id = ?&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">email_id</span><span class="p">],</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">status</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;completed&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Email </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2"> already fully enriched, skipping&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>

                <span class="c1"># Fetch email body</span>
                <span class="n">plain_body</span><span class="p">,</span> <span class="n">html_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_email_body</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">email_id</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">plain_body</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">html_body</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No email body found for </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_enrichment_status</span><span class="p">(</span>
                        <span class="n">conn</span><span class="p">,</span>
                        <span class="n">email_id</span><span class="p">,</span>
                        <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;No email body found&quot;</span><span class="p">,</span>
                        <span class="mi">0</span><span class="p">,</span>
                        <span class="kc">False</span><span class="p">,</span>
                        <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="c1"># Extract contact information</span>
                <span class="n">contact_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_contact_info</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">email_id</span><span class="p">)</span>

                <span class="c1"># Detect opportunities</span>
                <span class="n">opportunities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_opportunities</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">email_id</span><span class="p">)</span>

                <span class="c1"># Get email metadata</span>
                <span class="n">from_address</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">email_data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="s2">&quot;SELECT from_address, subject FROM raw_emails WHERE message_id = ?&quot;</span><span class="p">,</span>
                        <span class="p">[</span><span class="n">email_id</span><span class="p">],</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">email_data</span><span class="p">:</span>
                        <span class="n">from_address</span> <span class="o">=</span> <span class="n">email_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">subject</span> <span class="o">=</span> <span class="n">email_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No metadata found for email </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Calculate priority</span>
                <span class="n">priority_score</span><span class="p">,</span> <span class="n">priority_confidence</span><span class="p">,</span> <span class="n">priority_reason</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_priority</span><span class="p">(</span>
                        <span class="n">conn</span><span class="p">,</span>
                        <span class="n">email_id</span><span class="p">,</span>
                        <span class="n">from_address</span><span class="p">,</span>
                        <span class="n">subject</span><span class="p">,</span>
                        <span class="n">contact_info</span><span class="p">,</span>
                        <span class="n">opportunities</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Update enrichment status</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_enrichment_status</span><span class="p">(</span>
                    <span class="n">conn</span><span class="p">,</span>
                    <span class="n">email_id</span><span class="p">,</span>
                    <span class="n">priority_score</span><span class="p">,</span>
                    <span class="n">priority_reason</span><span class="p">,</span>
                    <span class="n">priority_confidence</span><span class="p">,</span>
                    <span class="nb">bool</span><span class="p">(</span><span class="n">contact_info</span><span class="p">),</span>
                    <span class="nb">bool</span><span class="p">(</span><span class="n">opportunities</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully enriched email </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error enriching email </span><span class="si">{</span><span class="n">email_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Try to update status to indicate failure</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_enrichment_status</span><span class="p">(</span>
                        <span class="n">conn</span><span class="p">,</span> <span class="n">email_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">return</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="ConnectionManager">
<a class="viewcode-back" href="../../../../../dewey.core.crm.enrichment.html#dewey.core.crm.enrichment.email_enrichment.ConnectionManager">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ConnectionManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager for database connections.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConnectionManager.__init__">
<a class="viewcode-back" href="../../../../../dewey.core.crm.enrichment.html#dewey.core.crm.enrichment.email_enrichment.ConnectionManager.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enrichment</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span> <span class="o">=</span> <span class="n">enrichment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_new</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># If connection exists and is open, use it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;closed&quot;</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">created_new</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use MotherDuck token if available</span>
            <span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">motherduck_token</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">db_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
                <span class="s2">&quot;md:&quot;</span>
            <span class="p">):</span>
                <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;motherduck_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">motherduck_token</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Connecting to MotherDuck database: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">db_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Connecting to local database: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">db_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Create new connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">created_new</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Database connection established&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="c1"># Close connection only if we created a new one</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_new</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Database connection closed&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enrichment</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error closing database connection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the email enrichment process.&quot;&quot;&quot;</span>
    <span class="n">enrichment</span> <span class="o">=</span> <span class="n">EmailEnrichment</span><span class="p">()</span>
    <span class="n">enrichment</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../index.html">Dewey (TUI)</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">dewey</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../../index.html">Module code</a><ul>
  <li><a href="../../../../dewey.html">dewey</a><ul>
  <li><a href="../../crm.html">dewey.core.crm</a><ul>
  <li><a href="../enrichment.html">dewey.core.crm.enrichment</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Sloane Ortel.

      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>

    </div>




  </body>
</html>
