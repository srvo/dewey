<!DOCTYPE html>

<html lang="en" data-content_root="../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dewey.core.crm.tests.test_communication &#8212; Dewey (TUI) 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />

  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />





  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for dewey.core.crm.tests.test_communication</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Tests for the CRM communication module.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">email</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">patch</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dewey.core.crm.communication.email_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">EmailClient</span>


<div class="viewcode-block" id="TestEmailClient">
<a class="viewcode-back" href="../../../../../dewey.core.crm.tests.html#dewey.core.crm.tests.test_communication.TestEmailClient">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestEmailClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test suite for the EmailClient class.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestEmailClient.test_initialization">
<a class="viewcode-back" href="../../../../../dewey.core.crm.tests.html#dewey.core.crm.tests.test_communication.TestEmailClient.test_initialization">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_initialization</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test EmailClient initialization.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_gmail&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_setup</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">EmailClient</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">client</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="s2">&quot;gmail&quot;</span>
            <span class="k">assert</span> <span class="n">client</span><span class="o">.</span><span class="n">config_section</span> <span class="o">==</span> <span class="s2">&quot;email_client&quot;</span>
            <span class="k">assert</span> <span class="n">client</span><span class="o">.</span><span class="n">requires_db</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="n">mock_setup</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestEmailClient.test_initialization_with_imap">
<a class="viewcode-back" href="../../../../../dewey.core.crm.tests.html#dewey.core.crm.tests.test_communication.TestEmailClient.test_initialization_with_imap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_initialization_with_imap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test EmailClient initialization with IMAP provider.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_imap&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_setup</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">EmailClient</span><span class="p">(</span><span class="n">provider</span><span class="o">=</span><span class="s2">&quot;generic_imap&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">client</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="s2">&quot;generic_imap&quot;</span>
            <span class="n">mock_setup</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestEmailClient.test_setup_imap">
<a class="viewcode-back" href="../../../../../dewey.core.crm.tests.html#dewey.core.crm.tests.test_communication.TestEmailClient.test_setup_imap">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;imaplib.IMAP4_SSL&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_setup_imap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_imap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test IMAP setup.&quot;&quot;&quot;</span>
        <span class="n">mock_imap_instance</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_imap</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_imap_instance</span>

        <span class="c1"># Create a client with _setup_imap patched out to avoid connection attempts</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_imap&quot;</span><span class="p">):</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">EmailClient</span><span class="p">()</span>

        <span class="c1"># Manually configure client for testing</span>
        <span class="n">client</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;email_client&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;imap_server&quot;</span><span class="p">:</span> <span class="s2">&quot;imap.test.com&quot;</span><span class="p">,</span>
                <span class="s2">&quot;imap_port&quot;</span><span class="p">:</span> <span class="s2">&quot;993&quot;</span><span class="p">,</span>
                <span class="s2">&quot;email_username&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
                <span class="s2">&quot;email_password&quot;</span><span class="p">:</span> <span class="s2">&quot;test_password&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># Call setup method directly</span>
        <span class="n">client</span><span class="o">.</span><span class="n">_setup_imap</span><span class="p">()</span>

        <span class="c1"># Verify</span>
        <span class="n">mock_imap</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;imap.test.com&quot;</span><span class="p">,</span> <span class="mi">993</span><span class="p">)</span>
        <span class="n">mock_imap_instance</span><span class="o">.</span><span class="n">login</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;test_password&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestEmailClient.test_fetch_emails_imap">
<a class="viewcode-back" href="../../../../../dewey.core.crm.tests.html#dewey.core.crm.tests.test_communication.TestEmailClient.test_fetch_emails_imap">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;imaplib.IMAP4_SSL&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_fetch_emails_imap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_imap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test fetching emails via IMAP.&quot;&quot;&quot;</span>
        <span class="c1"># Setup mock IMAP</span>
        <span class="n">mock_imap_instance</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_imap</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_imap_instance</span>

        <span class="c1"># Create a properly patched client to avoid real connections</span>
        <span class="k">with</span> <span class="p">(</span>
            <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_gmail&quot;</span><span class="p">),</span>
            <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_imap&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">EmailClient</span><span class="p">()</span>

        <span class="c1"># Mock search and fetch responses</span>
        <span class="n">mock_imap_instance</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;1 2 3&quot;</span><span class="p">])</span>

        <span class="c1"># Create a mock email message</span>
        <span class="n">mock_email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="p">()</span>
        <span class="n">mock_email</span><span class="p">[</span><span class="s2">&quot;Subject&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Test Subject&quot;</span>
        <span class="n">mock_email</span><span class="p">[</span><span class="s2">&quot;From&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Test User &lt;test@example.com&gt;&quot;</span>
        <span class="n">mock_email</span><span class="p">[</span><span class="s2">&quot;To&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;recipient@example.com&quot;</span>
        <span class="n">mock_email</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Thu, 1 Jan 2023 12:00:00 +0000&quot;</span>
        <span class="n">mock_email_bytes</span> <span class="o">=</span> <span class="n">mock_email</span><span class="o">.</span><span class="n">as_bytes</span><span class="p">()</span>

        <span class="c1"># Setup the fetch response for each email ID</span>
        <span class="n">mock_imap_instance</span><span class="o">.</span><span class="n">fetch</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="sa">b</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">mock_email_bytes</span><span class="p">)]),</span>
            <span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="sa">b</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">mock_email_bytes</span><span class="p">)]),</span>
            <span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="sa">b</span><span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">mock_email_bytes</span><span class="p">)]),</span>
        <span class="p">]</span>

        <span class="c1"># Set the mock connection</span>
        <span class="n">client</span><span class="o">.</span><span class="n">imap_conn</span> <span class="o">=</span> <span class="n">mock_imap_instance</span>

        <span class="c1"># Call the method</span>
        <span class="n">emails</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">_fetch_emails_imap</span><span class="p">(</span><span class="s2">&quot;INBOX&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Verify</span>
        <span class="n">mock_imap_instance</span><span class="o">.</span><span class="n">select</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;INBOX&quot;</span><span class="p">)</span>
        <span class="n">mock_imap_instance</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
        <span class="c1"># Check that fetch was called 3 times (once for each email ID)</span>
        <span class="k">assert</span> <span class="n">mock_imap_instance</span><span class="o">.</span><span class="n">fetch</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">emails</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span></div>


<div class="viewcode-block" id="TestEmailClient.test_decode_header">
<a class="viewcode-back" href="../../../../../dewey.core.crm.tests.html#dewey.core.crm.tests.test_communication.TestEmailClient.test_decode_header">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_decode_header</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test decoding email headers.&quot;&quot;&quot;</span>
        <span class="c1"># Create a client with patches to avoid real connections</span>
        <span class="k">with</span> <span class="p">(</span>
            <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_gmail&quot;</span><span class="p">),</span>
            <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_imap&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">EmailClient</span><span class="p">()</span>

        <span class="c1"># Test simple header</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">_decode_header</span><span class="p">(</span><span class="s2">&quot;Simple Header&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Simple Header&quot;</span>

        <span class="c1"># Test encoded header</span>
        <span class="n">encoded_header</span> <span class="o">=</span> <span class="s2">&quot;=?utf-8?q?Test=20Header?=&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">_decode_header</span><span class="p">(</span><span class="n">encoded_header</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s2">&quot;Test Header&quot;</span> <span class="ow">in</span> <span class="n">result</span></div>


<div class="viewcode-block" id="TestEmailClient.test_parse_email_header">
<a class="viewcode-back" href="../../../../../dewey.core.crm.tests.html#dewey.core.crm.tests.test_communication.TestEmailClient.test_parse_email_header">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_parse_email_header</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test parsing email headers.&quot;&quot;&quot;</span>
        <span class="c1"># Create a client with patches to avoid real connections</span>
        <span class="k">with</span> <span class="p">(</span>
            <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_gmail&quot;</span><span class="p">),</span>
            <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_imap&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">EmailClient</span><span class="p">()</span>

        <span class="c1"># Test with name and email</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">email_address</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">_parse_email_header</span><span class="p">(</span><span class="s2">&quot;John Doe &lt;john@example.com&gt;&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
        <span class="k">assert</span> <span class="n">email_address</span> <span class="o">==</span> <span class="s2">&quot;john@example.com&quot;</span>

        <span class="c1"># Test with quoted name</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">email_address</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">_parse_email_header</span><span class="p">(</span>
            <span class="s1">&#39;&quot;Doe, John&quot; &lt;john@example.com&gt;&#39;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Doe, John&quot;</span>
        <span class="k">assert</span> <span class="n">email_address</span> <span class="o">==</span> <span class="s2">&quot;john@example.com&quot;</span>

        <span class="c1"># Test with just email</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">email_address</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">_parse_email_header</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">email_address</span> <span class="o">==</span> <span class="s2">&quot;john@example.com&quot;</span></div>


<div class="viewcode-block" id="TestEmailClient.test_save_emails_to_db">
<a class="viewcode-back" href="../../../../../dewey.core.crm.tests.html#dewey.core.crm.tests.test_communication.TestEmailClient.test_save_emails_to_db">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;dewey.core.db.connection.get_connection&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_save_emails_to_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_get_connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test saving emails to the database.&quot;&quot;&quot;</span>
        <span class="c1"># Create a client with patches to avoid real connections</span>
        <span class="k">with</span> <span class="p">(</span>
            <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_gmail&quot;</span><span class="p">),</span>
            <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_imap&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">EmailClient</span><span class="p">()</span>

        <span class="c1"># Setup</span>
        <span class="n">mock_db</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_get_connection</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_db</span>
        <span class="n">client</span><span class="o">.</span><span class="n">db_conn</span> <span class="o">=</span> <span class="n">mock_db</span>

        <span class="n">emails</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;email_id&quot;</span><span class="p">:</span> <span class="s2">&quot;123&quot;</span><span class="p">,</span>
                <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;Test Subject&quot;</span><span class="p">,</span>
                <span class="s2">&quot;from_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
                <span class="s2">&quot;from_email&quot;</span><span class="p">:</span> <span class="s2">&quot;john@example.com&quot;</span><span class="p">,</span>
                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;recipient@example.com&quot;</span><span class="p">,</span>
                <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;2023-01-01 12:00:00&quot;</span><span class="p">,</span>
                <span class="s2">&quot;body_text&quot;</span><span class="p">:</span> <span class="s2">&quot;Test body&quot;</span><span class="p">,</span>
                <span class="s2">&quot;body_html&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;p&gt;Test body&lt;/p&gt;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;has_attachments&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="c1"># Execute</span>
        <span class="n">client</span><span class="o">.</span><span class="n">save_emails_to_db</span><span class="p">(</span><span class="n">emails</span><span class="p">)</span>

        <span class="c1"># Verify</span>
        <span class="k">assert</span> <span class="n">mock_db</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">call_count</span> <span class="o">&gt;=</span> <span class="mi">2</span>  <span class="c1"># One for CREATE TABLE, one for INSERT</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestEmailClient.test_close">
<a class="viewcode-back" href="../../../../../dewey.core.crm.tests.html#dewey.core.crm.tests.test_communication.TestEmailClient.test_close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test closing connections.&quot;&quot;&quot;</span>
        <span class="c1"># Create a client with patches to avoid real connections</span>
        <span class="k">with</span> <span class="p">(</span>
            <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_gmail&quot;</span><span class="p">),</span>
            <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EmailClient</span><span class="p">,</span> <span class="s2">&quot;_setup_imap&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">EmailClient</span><span class="p">()</span>

        <span class="n">mock_imap</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">imap_conn</span> <span class="o">=</span> <span class="n">mock_imap</span>

        <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">mock_imap</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
        <span class="n">mock_imap</span><span class="o">.</span><span class="n">logout</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">client</span><span class="o">.</span><span class="n">imap_conn</span> <span class="ow">is</span> <span class="kc">None</span></div>
</div>

</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../index.html">Dewey (TUI)</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">dewey</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../../index.html">Module code</a><ul>
  <li><a href="../../../../dewey.html">dewey</a><ul>
  <li><a href="../../crm.html">dewey.core.crm</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Sloane Ortel.

      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>

    </div>




  </body>
</html>
