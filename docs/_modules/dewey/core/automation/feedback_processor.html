<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dewey.core.automation.feedback_processor &#8212; Dewey (TUI) 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for dewey.core.automation.feedback_processor</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">duckdb</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dewey.core.base_script</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseScript</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dewey.core.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseConnection</span>


<div class="viewcode-block" id="FeedbackProcessor">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FeedbackProcessor</span><span class="p">(</span><span class="n">BaseScript</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes feedback and suggests changes to preferences.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FeedbackProcessor.__init__">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the FeedbackProcessor.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;FeedbackProcessor&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Processes feedback and suggests changes to preferences.&quot;</span><span class="p">,</span>
            <span class="n">config_section</span><span class="o">=</span><span class="s2">&quot;feedback_processor&quot;</span><span class="p">,</span>
            <span class="n">requires_db</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">enable_llm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_value</span><span class="p">(</span><span class="s2">&quot;paths.data_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="c1"># Ensure paths are properly constructed</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_data_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;process_feedback.duckdb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier_db</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;email_classifier.duckdb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Check if MotherDuck options are passed via command line</span>
        <span class="k">if</span> <span class="s2">&quot;--use-motherduck&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_motherduck</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_motherduck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_value</span><span class="p">(</span><span class="s2">&quot;use_motherduck&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check for motherduck_db argument</span>
        <span class="n">motherduck_db</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;--motherduck-db&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--motherduck-db&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">):</span>
                    <span class="n">motherduck_db</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">motherduck_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">motherduck_db</span> <span class="o">=</span> <span class="n">motherduck_db</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">motherduck_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_value</span><span class="p">(</span><span class="s2">&quot;motherduck_db&quot;</span><span class="p">,</span> <span class="s2">&quot;dewey&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FeedbackProcessor.generate_json">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor.generate_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">llm_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a structured JSON response from the LLM.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): The prompt to send to the LLM</span>
<span class="sd">            api_key (str, optional): API key for LLM service</span>
<span class="sd">            llm_client (LiteLLMClient, optional): An existing LLM client instance</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The structured JSON response or None if there was an error</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">llm_client</span><span class="p">:</span>
                <span class="n">client</span> <span class="o">=</span> <span class="n">llm_client</span>
            <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>
                <span class="c1"># Initialize the LLM client with the provided API key</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">dewey.llm.litellm_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLLMClient</span><span class="p">,</span> <span class="n">LiteLLMConfig</span>

                <span class="n">config</span> <span class="o">=</span> <span class="n">LiteLLMConfig</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4-1106-preview&quot;</span><span class="p">)</span>
                <span class="n">client</span> <span class="o">=</span> <span class="n">LiteLLMClient</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">:</span>
                <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;No LLM client or API key provided, unable to generate JSON&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="kn">from</span><span class="w"> </span><span class="nn">litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Message</span>

            <span class="n">message</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Message</span><span class="p">(</span>
                    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="s2">&quot;You are a helpful assistant that responds in JSON format.&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">Message</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">prompt</span><span class="p">),</span>
            <span class="p">]</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4-1106-preview&quot;</span><span class="p">,</span>
                <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;json_object&quot;</span><span class="p">},</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid response received from LLM&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating JSON from LLM: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_create_email_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">DatabaseConnection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the email_analyses table if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use different schema syntax depending on whether we&#39;re using MotherDuck or local DB</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_motherduck</span><span class="p">:</span>
                <span class="c1"># For MotherDuck, use the database name directly</span>
                <span class="n">table_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For local DB, use the attached database name</span>
                <span class="n">table_prefix</span> <span class="o">=</span> <span class="s2">&quot;classifier_db.&quot;</span>

            <span class="c1"># Check if the email_analyses table exists</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_motherduck</span><span class="p">:</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = &#39;email_analyses&#39;)&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For local database with attachment</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT EXISTS (SELECT 1 FROM classifier_db.sqlite_master WHERE type=&#39;table&#39; AND name=&#39;email_analyses&#39;)&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Create the table if it doesn&#39;t exist</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating email_analyses table&quot;</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE TABLE </span><span class="si">{</span><span class="n">table_prefix</span><span class="si">}</span><span class="s2">email_analyses (</span>
<span class="s2">                    msg_id TEXT PRIMARY KEY,</span>
<span class="s2">                    thread_id TEXT,</span>
<span class="s2">                    subject TEXT,</span>
<span class="s2">                    from_address TEXT,</span>
<span class="s2">                    priority INTEGER,</span>
<span class="s2">                    snippet TEXT,</span>
<span class="s2">                    analysis_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
<span class="s2">                )</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># Add a few test emails if none exist</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SELECT COUNT(*) FROM </span><span class="si">{</span><span class="n">table_prefix</span><span class="si">}</span><span class="s2">email_analyses&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No emails found in database, adding some test data&quot;</span><span class="p">)</span>
                <span class="c1"># Add a variety of test emails from different senders and categories</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO </span><span class="si">{</span><span class="n">table_prefix</span><span class="si">}</span><span class="s2">email_analyses</span>
<span class="s2">                (msg_id, thread_id, subject, from_address, priority, snippet, analysis_date)</span>
<span class="s2">                VALUES</span>
<span class="s2">                (&#39;work1&#39;, &#39;thread1&#39;, &#39;Project Update: Q2 Roadmap&#39;, &#39;manager@company.com&#39;, 3, &#39;Here is the updated roadmap for Q2. Please review the milestones and provide feedback by Friday.&#39;, CURRENT_TIMESTAMP),</span>
<span class="s2">                (&#39;work2&#39;, &#39;thread2&#39;, &#39;Meeting Notes - Product Team&#39;, &#39;team-leader@company.com&#39;, 2, &#39;Attached are the notes from yesterday&#39;&#39;s product meeting. Key action items highlighted.&#39;, CURRENT_TIMESTAMP),</span>
<span class="s2">                (&#39;work3&#39;, &#39;thread3&#39;, &#39;Urgent: Server Downtime Alert&#39;, &#39;alerts@monitoring.com&#39;, 4, &#39;Our monitoring system has detected high load on production servers. Immediate action required.&#39;, CURRENT_TIMESTAMP),</span>
<span class="s2">                (&#39;news1&#39;, &#39;thread4&#39;, &#39;Weekly Newsletter: Tech Industry Updates&#39;, &#39;newsletter@techupdates.com&#39;, 1, &#39;This week in tech: Apple announces new products, Google updates search algorithm, and more.&#39;, CURRENT_TIMESTAMP),</span>
<span class="s2">                (&#39;news2&#39;, &#39;thread5&#39;, &#39;Daily Digest: Financial News&#39;, &#39;news@finance-updates.com&#39;, 1, &#39;Market summary: S&amp;P 500 up 1.2%, NASDAQ down 0.3%. Top stories include quarterly earnings reports.&#39;, CURRENT_TIMESTAMP),</span>
<span class="s2">                (&#39;personal1&#39;, &#39;thread6&#39;, &#39;Dinner next week?&#39;, &#39;friend@personal.com&#39;, 2, &#39;Would you be available for dinner next Tuesday? We could try that new restaurant downtown.&#39;, CURRENT_TIMESTAMP),</span>
<span class="s2">                (&#39;receipt1&#39;, &#39;thread7&#39;, &#39;Your Amazon Order Has Shipped&#39;, &#39;orders@amazon.com&#39;, 1, &#39;Your order #12345 has shipped and is expected to arrive on Thursday. Track your package here.&#39;, CURRENT_TIMESTAMP),</span>
<span class="s2">                (&#39;marketing1&#39;, &#39;thread8&#39;, &#39;Special Offer: 25% Off Summer Collection&#39;, &#39;marketing@retailer.com&#39;, 0, &#39;Summer sale starts now! Take 25% off all summer items with code SUMMER25 at checkout.&#39;, CURRENT_TIMESTAMP),</span>
<span class="s2">                (&#39;work4&#39;, &#39;thread9&#39;, &#39;Code Review Request: New Feature&#39;, &#39;developer@company.com&#39;, 3, &#39;I&#39;&#39;ve completed the new user authentication feature. Could you review my pull request when you have time?&#39;, CURRENT_TIMESTAMP),</span>
<span class="s2">                (&#39;important1&#39;, &#39;thread10&#39;, &#39;Contract Renewal: Urgent Action Required&#39;, &#39;legal@partner.com&#39;, 4, &#39;The service contract expires in 10 days. We need your decision on renewal terms by Monday.&#39;, CURRENT_TIMESTAMP)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Added 10 test emails to </span><span class="si">{</span><span class="n">table_prefix</span><span class="si">}</span><span class="s2">email_analyses&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Add different types of topics to support tagging</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating sample topics in preferences table&quot;</span><span class="p">)</span>
                <span class="n">default_preferences</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                        <span class="s2">&quot;sender&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                        <span class="s2">&quot;content_value&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                        <span class="s2">&quot;sender_history&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;topic_list&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;work&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;personal&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;newsletter&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;receipt&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;marketing&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;urgent&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;finance&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;tech&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;project&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;sender_list&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;company.com&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;amazon.com&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;newsletter@techupdates.com&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;alerts@monitoring.com&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;marketing@retailer.com&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;override_rules&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">}</span>

                <span class="c1"># Save default preferences with sample topics if not exists</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT COUNT(*) FROM preferences WHERE key = &#39;email_preferences&#39;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_preferences</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">default_preferences</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating email tables: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="FeedbackProcessor.init_db">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor.init_db">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier_db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatabaseConnection</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the database for feedback processing.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># First try to connect to MotherDuck</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_motherduck</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to connect to MotherDuck database&quot;</span><span class="p">)</span>
                    <span class="c1"># Get token from environment or config</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MOTHERDUCK_TOKEN&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_value</span><span class="p">(</span>
                        <span class="s2">&quot;motherduck_token&quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;MotherDuck token not found in environment or config&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">use_motherduck</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Format the connection string properly</span>
                        <span class="n">connection_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;md:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">motherduck_db</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MOTHERDUCK_TOKEN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
                        <span class="n">conn</span> <span class="o">=</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connection_string</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Connected to MotherDuck database: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">motherduck_db</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                        <span class="c1"># Create feedback tables if they don&#39;t exist</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_create_feedback_tables</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

                        <span class="c1"># Connect to the classifier database in MotherDuck</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">classifier_db_path</span><span class="p">:</span>
                            <span class="c1"># If no explicit path is provided, use remote classifier DB</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Check if email_analyses table exists in MotherDuck</span>
                                <span class="n">exists</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                                    <span class="s2">&quot;SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = &#39;email_analyses&#39;)&quot;</span>
                                <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                                <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                        <span class="s2">&quot;Found email_analyses table in MotherDuck&quot;</span>
                                    <span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">classifier_db</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="kc">None</span>  <span class="c1"># No need for local attachment</span>
                                    <span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># Create email_analyses table in MotherDuck</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_create_email_tables</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                        <span class="s2">&quot;Created email_analyses table in MotherDuck&quot;</span>
                                    <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Error checking email_analyses table in MotherDuck: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="c1"># Fall back to local DB</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">use_motherduck</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">return</span> <span class="n">conn</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to connect to MotherDuck: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Falling back to local database&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">use_motherduck</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Fall back to local database if MotherDuck not available or not configured</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using local database: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_file</span><span class="p">)</span>

            <span class="c1"># Create feedback tables</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_feedback_tables</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

            <span class="c1"># Connect to classifier DB</span>
            <span class="k">if</span> <span class="n">classifier_db_path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">classifier_db</span> <span class="o">=</span> <span class="n">classifier_db_path</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try to attach the classifier database</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier_db</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ATTACH &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">classifier_db</span><span class="si">}</span><span class="s2">&#39; AS classifier_db&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Attached classifier database: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">classifier_db</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Create or verify the email_analyses table exists</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_email_tables</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Created or verified email_analyses table exists in classifier_db&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating email tables: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">conn</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error initializing database: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_create_feedback_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">DatabaseConnection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create feedback and preferences tables if they don&#39;t exist.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create feedback table</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                CREATE TABLE IF NOT EXISTS feedback (</span>
<span class="sd">                    msg_id VARCHAR PRIMARY KEY,</span>
<span class="sd">                    subject VARCHAR,</span>
<span class="sd">                    assigned_priority INTEGER,</span>
<span class="sd">                    feedback_comments VARCHAR,</span>
<span class="sd">                    suggested_priority INTEGER,</span>
<span class="sd">                    add_to_topics VARCHAR[],</span>
<span class="sd">                    add_to_source VARCHAR,</span>
<span class="sd">                    timestamp DOUBLE</span>
<span class="sd">                )</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Create preferences table</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                CREATE TABLE IF NOT EXISTS preferences (</span>
<span class="sd">                    key VARCHAR PRIMARY KEY,</span>
<span class="sd">                    config JSON</span>
<span class="sd">                )</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Add indexes for common queries</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                CREATE INDEX IF NOT EXISTS feedback_timestamp_idx</span>
<span class="sd">                ON feedback(timestamp)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created or verified feedback tables&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating feedback tables: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="FeedbackProcessor.load_feedback">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor.load_feedback">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">DatabaseConnection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load feedback entries from database.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of feedback entries.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM feedback&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM feedback LIMIT 0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">description</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span></div>


<div class="viewcode-block" id="FeedbackProcessor.load_preferences">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor.load_preferences">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">DatabaseConnection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load preferences from database.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of preferences.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Default preferences</span>
        <span class="n">default_preferences</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                <span class="s2">&quot;sender&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                <span class="s2">&quot;content_value&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                <span class="s2">&quot;sender_history&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;topic_list&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;sender_list&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;override_rules&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;SELECT config FROM preferences WHERE key = &#39;email_preferences&#39;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">config_json</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">config_json</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Store default preferences if none found</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_preferences</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">default_preferences</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default_preferences</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading preferences: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">default_preferences</span></div>


<div class="viewcode-block" id="FeedbackProcessor.save_feedback">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor.save_feedback">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_feedback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">DatabaseConnection</span><span class="p">,</span> <span class="n">feedback_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save feedback entries to database.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection object.</span>
<span class="sd">            feedback_data: List of feedback entries.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">feedback_data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if this feedback already exists</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT COUNT(*) FROM feedback WHERE msg_id = ?&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;msg_id&quot;</span><span class="p">]]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                    <span class="c1"># Update existing record</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        UPDATE feedback</span>
<span class="sd">                        SET subject = ?,</span>
<span class="sd">                            assigned_priority = ?,</span>
<span class="sd">                            feedback_comments = ?,</span>
<span class="sd">                            suggested_priority = ?,</span>
<span class="sd">                            add_to_topics = ?,</span>
<span class="sd">                            add_to_source = ?,</span>
<span class="sd">                            timestamp = ?</span>
<span class="sd">                        WHERE msg_id = ?</span>
<span class="sd">                        &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">[</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assigned_priority&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;feedback_comments&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suggested_priority&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_to_topics&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_to_source&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
                            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;msg_id&quot;</span><span class="p">],</span>
                        <span class="p">],</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Insert new record</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        INSERT INTO feedback (</span>
<span class="sd">                            msg_id, subject, assigned_priority, feedback_comments,</span>
<span class="sd">                            suggested_priority, add_to_topics, add_to_source, timestamp</span>
<span class="sd">                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)</span>
<span class="sd">                        &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">[</span>
                            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;msg_id&quot;</span><span class="p">],</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assigned_priority&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;feedback_comments&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suggested_priority&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_to_topics&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_to_source&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
                        <span class="p">],</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving feedback: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FeedbackProcessor.save_preferences">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor.save_preferences">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">DatabaseConnection</span><span class="p">,</span> <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save preferences to database.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection object.</span>
<span class="sd">            preferences: Dictionary of preferences.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Convert preferences to JSON string</span>
            <span class="n">config_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">preferences</span><span class="p">)</span>

            <span class="c1"># Check if preferences already exist</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;SELECT COUNT(*) FROM preferences WHERE key = &#39;email_preferences&#39;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                <span class="c1"># Update existing preferences</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;UPDATE preferences SET config = ? WHERE key = &#39;email_preferences&#39;&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">config_json</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Insert new preferences</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;INSERT INTO preferences (key, config) VALUES (?, ?)&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="s2">&quot;email_preferences&quot;</span><span class="p">,</span> <span class="n">config_json</span><span class="p">],</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving preferences: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FeedbackProcessor.generate_feedback_json">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor.generate_feedback_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_feedback_json</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">feedback_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">msg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">assigned_priority</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">llm_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deepinfra_api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Uses Deepinfra API to structure natural language feedback into JSON.</span>
<span class="sd">        Returns dict with &#39;error&#39; field if processing fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First check for simple priority overrides without API call</span>
        <span class="n">feedback_lower</span> <span class="o">=</span> <span class="n">feedback_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;unsubscribe&quot;</span> <span class="ow">in</span> <span class="n">feedback_lower</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;msg_id&quot;</span><span class="p">:</span> <span class="n">msg_id</span><span class="p">,</span>
                <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
                <span class="s2">&quot;assigned_priority&quot;</span><span class="p">:</span> <span class="n">assigned_priority</span><span class="p">,</span>
                <span class="s2">&quot;feedback_comments&quot;</span><span class="p">:</span> <span class="s2">&quot;Automatic priority cap at 2 due to unsubscribe mention&quot;</span><span class="p">,</span>
                <span class="s2">&quot;suggested_priority&quot;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">assigned_priority</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;add_to_topics&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;add_to_source&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="p">}</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">You are a feedback processing assistant.  You are given natural language feedback on an email&#39;s assigned priority, along with the email&#39;s subject and ID.  Your task is to structure this feedback into a JSON object.</span>

<span class="s2">Input Data:</span>

<span class="s2">*   Message ID: </span><span class="si">{</span><span class="n">msg_id</span><span class="si">}</span>
<span class="s2">*   Subject: </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span>
<span class="s2">*   Assigned Priority: </span><span class="si">{</span><span class="n">assigned_priority</span><span class="si">}</span>
<span class="s2">*   Feedback: </span><span class="si">{</span><span class="n">feedback_text</span><span class="si">}</span>

<span class="s2">Output Requirements:</span>

<span class="s2">Return a JSON object with the following fields:</span>

<span class="se">{{</span>
<span class="s2">    &quot;msg_id&quot;: &quot;auto-generated-id&quot;, &quot;subject&quot;: &quot;optional description&quot;, &quot;assigned_priority&quot;: 0, &quot;feedback_comments&quot;: &quot;cleaned feedback summary&quot;, &quot;suggested_priority&quot;: null, &quot;add_to_topics&quot;: null, &quot;add_to_source&quot;: null, &quot;timestamp&quot;: 1710300000.123</span>
<span class="se">}}</span>

<span class="s2">Key requirements:</span>
<span class="s2">1. DO NOT use code formatting (remove any ```json or ``` markers)</span>
<span class="s2">2. ALL output must be valid JSON - no comments, code examples or explanations</span>
<span class="s2">3. All fields MUST use the exact names shown above</span>
<span class="s2">4. JSON must be plain text - never wrapped in code blocks</span>
<span class="s2">5. If any field can&#39;t be determined, use `null`</span>

<span class="s2">Failure to follow these requirements will cause critical system errors. Always return pure JSON.</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="c1"># deepinfra_api_key = self.get_config_value(&quot;llm.providers.deepinfra.api_key&quot;)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deepinfra_api_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DEEPINFRA_API_KEY environment variable not set&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;1. Get your API key from https://deepinfra.com&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;2. Run: export DEEPINFRA_API_KEY=&#39;your-key-here&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_json</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">deepinfra_api_key</span><span class="p">,</span> <span class="n">llm_client</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">feedback_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response_content</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">feedback_json</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">feedback_json</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;API response was not valid JSON: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Response Text: </span><span class="si">{</span><span class="n">response_content</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span> <span class="s2">&quot;feedback_text&quot;</span><span class="p">:</span> <span class="n">feedback_text</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calling AI API: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Check your DEEPINFRA_API_KEY and internet connection&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="FeedbackProcessor.suggest_rule_changes">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor.suggest_rule_changes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">suggest_rule_changes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">feedback_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyzes feedback and suggests changes to preferences.</span>

<span class="sd">        Args:</span>
<span class="sd">            feedback_data: List of feedback entries.</span>
<span class="sd">            preferences: Dictionary of preferences.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of suggested changes.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">suggested_changes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">feedback_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feedback_data</span><span class="p">)</span>

        <span class="c1"># Minimum feedback count before suggestions are made</span>
        <span class="k">if</span> <span class="n">feedback_count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not enough feedback data to suggest changes.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># 1. Analyze Feedback Distribution</span>
        <span class="n">priority_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;assigned_priority&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">feedback_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Priority Distribution in Feedback: </span><span class="si">{</span><span class="n">priority_counts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Identify Frequent Discrepancies</span>
        <span class="n">discrepancy_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="n">topic_suggestions</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Store suggested topic changes</span>
        <span class="n">source_suggestions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">feedback_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">:</span>  <span class="c1"># skip if empty</span>
                <span class="k">continue</span>
            <span class="c1"># extract comment, subject, and feedback</span>
            <span class="n">feedback_comment</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;feedback_comments&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">assigned_priority</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assigned_priority&quot;</span><span class="p">))</span>
            <span class="n">suggested_priority</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suggested_priority&quot;</span><span class="p">)</span>
            <span class="n">add_to_topics</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_to_topics&quot;</span><span class="p">)</span>
            <span class="n">add_to_source</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_to_source&quot;</span><span class="p">)</span>

            <span class="c1"># check if there is a discrepancy</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">assigned_priority</span> <span class="o">!=</span> <span class="n">suggested_priority</span>
                <span class="ow">and</span> <span class="n">suggested_priority</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">discrepancy_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">assigned_priority</span><span class="p">,</span> <span class="n">suggested_priority</span><span class="p">)</span>
                <span class="n">discrepancy_counts</span><span class="p">[</span><span class="n">discrepancy_key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># check if keywords are in topics or source</span>
                <span class="k">if</span> <span class="n">add_to_topics</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">add_to_topics</span><span class="p">:</span>
                        <span class="c1"># Suggest adding to topics</span>
                        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">topic_suggestions</span><span class="p">:</span>
                            <span class="n">topic_suggestions</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="s2">&quot;suggested_priority&quot;</span><span class="p">:</span> <span class="n">suggested_priority</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="n">topic_suggestions</span><span class="p">[</span><span class="n">keyword</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">topic_suggestions</span><span class="p">[</span><span class="n">keyword</span><span class="p">][</span><span class="s2">&quot;suggested_priority&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">suggested_priority</span>  <span class="c1"># Update if higher</span>
                        <span class="p">)</span>

                <span class="c1"># Suggest adding to source</span>
                <span class="k">if</span> <span class="n">add_to_source</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">add_to_source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source_suggestions</span><span class="p">:</span>
                        <span class="n">source_suggestions</span><span class="p">[</span><span class="n">add_to_source</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s2">&quot;suggested_priority&quot;</span><span class="p">:</span> <span class="n">suggested_priority</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="n">source_suggestions</span><span class="p">[</span><span class="n">add_to_source</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">source_suggestions</span><span class="p">[</span><span class="n">add_to_source</span><span class="p">][</span><span class="s2">&quot;suggested_priority&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">suggested_priority</span>  <span class="c1"># Update if higher</span>
                    <span class="p">)</span>
        <span class="c1"># Output the most common discrepancies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Most Common Discrepancies: </span><span class="si">{</span><span class="n">discrepancy_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># 3.  Suggest *new* override rules.  This is the most important part.</span>
        <span class="k">for</span> <span class="n">topic</span><span class="p">,</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="n">topic_suggestions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">suggestion</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Require at least 3 occurrences</span>
                <span class="n">suggested_changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;add_override_rule&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="n">topic</span><span class="p">,</span>
                        <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="n">suggestion</span><span class="p">[</span><span class="s2">&quot;suggested_priority&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Suggested based on feedback (topic appeared </span><span class="si">{</span><span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> times with consistent priority suggestion)&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="n">source_suggestions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">suggestion</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">suggested_changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;add_override_rule&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
                        <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="n">suggestion</span><span class="p">[</span><span class="s2">&quot;suggested_priority&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Suggested based on feedback (source appeared </span><span class="si">{</span><span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> times with consistent priority suggestion)&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="c1"># 4 Suggest changes to existing weights.</span>
        <span class="n">discrepancy_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">valid_discrepancy_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">assigned</span><span class="p">,</span> <span class="n">suggested</span><span class="p">),</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">discrepancy_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">suggested</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># make sure suggested priority is not null</span>
                <span class="n">discrepancy_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">suggested</span> <span class="o">-</span> <span class="n">assigned</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span>
                <span class="n">valid_discrepancy_count</span> <span class="o">+=</span> <span class="n">count</span>
        <span class="n">average_discrepancy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">discrepancy_sum</span> <span class="o">/</span> <span class="n">valid_discrepancy_count</span> <span class="k">if</span> <span class="n">valid_discrepancy_count</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># Map overall discrepancy to a specific score adjustment.  This is a heuristic.</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">average_discrepancy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="c1"># Example: If priorities are consistently too low, increase the weight of content_value.</span>
            <span class="k">if</span> <span class="n">average_discrepancy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">suggested_changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;adjust_weight&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;score_name&quot;</span><span class="p">:</span> <span class="s2">&quot;content_value_score&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;adjustment&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># Increase weight by 10%</span>
                        <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Priorities are consistently lower than user feedback suggests.&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">suggested_changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;adjust_weight&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;score_name&quot;</span><span class="p">:</span> <span class="s2">&quot;automation_score&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;adjustment&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># Increase weight (making the impact of automation_score *lower*)</span>
                        <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Priorities are consistently higher than user feedback suggests.&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">suggested_changes</span></div>


<div class="viewcode-block" id="FeedbackProcessor.update_preferences">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor.update_preferences">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">changes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies suggested changes to the preferences.</span>

<span class="sd">        Args:</span>
<span class="sd">            preferences: Dictionary of preferences.</span>
<span class="sd">            changes: List of suggested changes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Updated dictionary of preferences.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">updated_preferences</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Work on a copy</span>

        <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;add_override_rule&quot;</span><span class="p">:</span>
                <span class="n">new_rule</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;keywords&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">change</span><span class="p">[</span><span class="s2">&quot;keyword&quot;</span><span class="p">]],</span>
                    <span class="s2">&quot;min_priority&quot;</span><span class="p">:</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="c1"># Check if the rule already exists</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">updated_preferences</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;override_rules&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;keyword&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;keywords&quot;</span><span class="p">]:</span>
                        <span class="n">exists</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
                    <span class="n">updated_preferences</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;override_rules&quot;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">new_rule</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Added override rule: </span><span class="si">{</span><span class="n">new_rule</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Override rule already exists&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;adjust_weight&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Weight adjustment is only a suggestion, not automatically applied. Manual adjustment recommended&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">updated_preferences</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_opportunities</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">DatabaseConnection</span><span class="p">,</span> <span class="n">table_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;classifier_db.&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get emails that need feedback.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Query recently processed emails from the classifier DB</span>
            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT msg_id, thread_id, subject, from_address, priority, snippet</span>
<span class="s2">            FROM </span><span class="si">{</span><span class="n">table_prefix</span><span class="si">}</span><span class="s2">email_analyses</span>
<span class="s2">            ORDER BY from_address, subject</span>
<span class="s2">            LIMIT 100</span>
<span class="s2">            &quot;&quot;&quot;</span>

            <span class="n">results</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No emails found in the classifier database&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> emails from </span><span class="si">{</span><span class="nb">len</span><span class="p">({</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">results</span><span class="p">})</span><span class="si">}</span><span class="s2"> senders:&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting emails for feedback: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_interactive_feedback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">DatabaseConnection</span><span class="p">,</span> <span class="n">opportunities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process email feedback interactively.</span>

<span class="sd">        Args:</span>
<span class="sd">            conn: Database connection</span>
<span class="sd">            opportunities: List of email tuples (msg_id, thread_id, subject, from_address, priority, snippet)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of feedback dictionaries</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opportunities</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No emails to process for feedback.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Print help information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_feedback_help</span><span class="p">()</span>

        <span class="c1"># Group emails by sender</span>
        <span class="n">emails_by_sender</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">opportunities</span><span class="p">:</span>
            <span class="c1"># Make sure we have a proper tuple with expected indices</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping invalid email record: </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Get email data</span>
            <span class="n">msg_id</span> <span class="o">=</span> <span class="n">email</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">thread_id</span> <span class="o">=</span> <span class="n">email</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="n">email</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">sender</span> <span class="o">=</span> <span class="n">email</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="n">email</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="k">else</span> <span class="mi">3</span>  <span class="c1"># Default to medium priority</span>
            <span class="n">snippet</span> <span class="o">=</span> <span class="n">email</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="n">sender</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">emails_by_sender</span><span class="p">:</span>
                <span class="n">emails_by_sender</span><span class="p">[</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">emails_by_sender</span><span class="p">[</span><span class="n">sender</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;msg_id&quot;</span><span class="p">:</span> <span class="n">msg_id</span><span class="p">,</span>
                    <span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="n">thread_id</span><span class="p">,</span>
                    <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
                    <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                    <span class="s2">&quot;snippet&quot;</span><span class="p">:</span> <span class="n">snippet</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Process emails by sender</span>
        <span class="n">feedback_entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sender_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">emails_by_sender</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">emails</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">emails_by_sender</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Sender </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sender_count</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">email</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">emails</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Email </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">email</span><span class="p">[</span><span class="s1">&#39;msg_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Priority: </span><span class="si">{</span><span class="n">email</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">email</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;snippet&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Snippet: </span><span class="si">{</span><span class="n">email</span><span class="p">[</span><span class="s1">&#39;snippet&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Get feedback</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">feedback</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;  Feedback (0-4/t/i/r/s/q/h): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                        <span class="c1"># Check for quit</span>
                        <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">feedback_entries</span>

                        <span class="c1"># Check for help</span>
                        <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;help&quot;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_print_feedback_help</span><span class="p">()</span>
                            <span class="k">continue</span>

                        <span class="c1"># Check for skip</span>
                        <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">):</span>
                            <span class="k">break</span>

                        <span class="c1"># Check for priority</span>
                        <span class="k">if</span> <span class="n">feedback</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">):</span>
                            <span class="n">priority</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>
                            <span class="n">feedback_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;msg_id&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;msg_id&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;original_priority&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;assigned_priority&quot;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                                    <span class="s2">&quot;feedback_comments&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Priority changed to </span><span class="si">{</span><span class="n">priority</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Priority set to </span><span class="si">{</span><span class="n">priority</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">break</span>

                        <span class="c1"># Check for tagging</span>
                        <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;tag&quot;</span><span class="p">):</span>
                            <span class="n">topics</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;  Enter topics (comma-separated): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">topics</span><span class="p">:</span>
                                <span class="n">feedback_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s2">&quot;msg_id&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;msg_id&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;original_priority&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;assigned_priority&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;add_to_topics&quot;</span><span class="p">:</span> <span class="n">topics</span><span class="p">,</span>
                                        <span class="s2">&quot;feedback_comments&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Tagged with: </span><span class="si">{</span><span class="n">topics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Tagged with: </span><span class="si">{</span><span class="n">topics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">break</span>

                        <span class="c1"># Check for rule</span>
                        <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;rule&quot;</span><span class="p">):</span>
                            <span class="n">rule_type</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                                <span class="s2">&quot;  Rule type (topic/sender/block): &quot;</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">rule_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;topic&quot;</span><span class="p">,</span> <span class="s2">&quot;sender&quot;</span><span class="p">,</span> <span class="s2">&quot;block&quot;</span><span class="p">):</span>
                                <span class="n">rule_value</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">rule_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> value: &quot;</span>
                                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">rule_value</span><span class="p">:</span>
                                    <span class="n">feedback_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                        <span class="p">{</span>
                                            <span class="s2">&quot;msg_id&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;msg_id&quot;</span><span class="p">],</span>
                                            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">],</span>
                                            <span class="s2">&quot;original_priority&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">],</span>
                                            <span class="s2">&quot;assigned_priority&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">],</span>
                                            <span class="s2">&quot;feedback_comments&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Create </span><span class="si">{</span><span class="n">rule_type</span><span class="si">}</span><span class="s2"> rule for: </span><span class="si">{</span><span class="n">rule_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                            <span class="s2">&quot;rule_type&quot;</span><span class="p">:</span> <span class="n">rule_type</span><span class="p">,</span>
                                            <span class="s2">&quot;rule_value&quot;</span><span class="p">:</span> <span class="n">rule_value</span><span class="p">,</span>
                                            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                                        <span class="p">}</span>
                                    <span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;  Created </span><span class="si">{</span><span class="n">rule_type</span><span class="si">}</span><span class="s2"> rule for: </span><span class="si">{</span><span class="n">rule_value</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="p">)</span>
                            <span class="k">break</span>

                        <span class="c1"># Check for ingest</span>
                        <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;ingest&quot;</span><span class="p">):</span>
                            <span class="n">ingest_type</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                                <span class="s2">&quot;  Ingest type (form/contact/task): &quot;</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">ingest_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">,</span> <span class="s2">&quot;contact&quot;</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">):</span>
                                <span class="n">feedback_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s2">&quot;msg_id&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;msg_id&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;original_priority&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;assigned_priority&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;feedback_comments&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Ingest as </span><span class="si">{</span><span class="n">ingest_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;ingest_type&quot;</span><span class="p">:</span> <span class="n">ingest_type</span><span class="p">,</span>
                                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;  Marked for ingestion as: </span><span class="si">{</span><span class="n">ingest_type</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                            <span class="k">break</span>

                        <span class="c1"># Default to comment</span>
                        <span class="k">if</span> <span class="n">feedback</span><span class="p">:</span>
                            <span class="n">feedback_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;msg_id&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;msg_id&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;original_priority&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;assigned_priority&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;feedback_comments&quot;</span><span class="p">:</span> <span class="n">feedback</span><span class="p">,</span>
                                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Comment added: </span><span class="si">{</span><span class="n">feedback</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">break</span>

                    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user.&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">feedback_entries</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing feedback: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">feedback_entries</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_print_feedback_help</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print help information for the feedback processor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== FEEDBACK HELP ===&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  0-4        Set priority (0=lowest, 4=highest)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  t, tag     Tag email with topics&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  i, ingest  Mark for ingestion (form/contact/task)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  r, rule    Create rule for this sender&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  s, skip    Skip this email&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  q, quit    Quit and save progress&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  h, ?       Show this help&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  [text]     Add a comment&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;======================&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="FeedbackProcessor.execute">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor.execute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the feedback processor.</span>

<span class="sd">        This implementation satisfies the abstract method requirement from BaseScript.</span>
<span class="sd">        Delegates to the run method for actual implementation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting execution of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully completed feedback processing&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing feedback processor: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="FeedbackProcessor.run">
<a class="viewcode-back" href="../../../../dewey.core.automation.html#dewey.core.automation.feedback_processor.FeedbackProcessor.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the feedback processor.&quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Initialize database connection</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span>

            <span class="c1"># Log the type of database being used</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_motherduck</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using MotherDuck database: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">motherduck_db</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using local database&quot;</span><span class="p">)</span>

            <span class="c1"># Define table prefix based on database type</span>
            <span class="n">table_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_motherduck</span> <span class="k">else</span> <span class="s2">&quot;classifier_db.&quot;</span>

            <span class="c1"># Load existing feedback and preferences</span>
            <span class="n">existing_feedback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_feedback</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="n">preferences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_preferences</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

            <span class="c1"># Handle JSON to database migration if found</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_migrate_json_to_db</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">existing_feedback</span><span class="p">,</span> <span class="n">preferences</span><span class="p">)</span>

            <span class="c1"># Get email data from classifier database</span>
            <span class="n">opportunities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_opportunities</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">table_prefix</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">opportunities</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;No emails found for feedback. Please run the email classifier first.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># Print help information</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_feedback_help</span><span class="p">()</span>

            <span class="c1"># Process feedback interactively</span>
            <span class="n">new_feedback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_interactive_feedback</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">opportunities</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">new_feedback</span><span class="p">:</span>
                <span class="c1"># Combine old and new feedback</span>
                <span class="n">all_feedback</span> <span class="o">=</span> <span class="n">existing_feedback</span> <span class="o">+</span> <span class="n">new_feedback</span>

                <span class="c1"># Save the feedback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_feedback</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">all_feedback</span><span class="p">)</span>

                <span class="c1"># Suggest rule changes based on feedback</span>
                <span class="n">rule_changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggest_rule_changes</span><span class="p">(</span><span class="n">all_feedback</span><span class="p">,</span> <span class="n">preferences</span><span class="p">)</span>

                <span class="c1"># If there are suggested changes, update preferences</span>
                <span class="k">if</span> <span class="n">rule_changes</span><span class="p">:</span>
                    <span class="n">preferences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_preferences</span><span class="p">(</span><span class="n">preferences</span><span class="p">,</span> <span class="n">rule_changes</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_preferences</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">preferences</span><span class="p">)</span>

                <span class="c1"># Ensure MotherDuck sync if using MotherDuck</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_motherduck</span><span class="p">:</span>
                    <span class="c1"># Execute a simple query to ensure data is committed to MotherDuck</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT 1&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Data synchronized with MotherDuck&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No new feedback collected. Exiting.&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation cancelled by user. Saving progress...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Ensure data is committed before exiting</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT 1&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error committing data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during feedback processing: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Close database connection</span>
            <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier_db</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Detach classifier DB if attached</span>
                            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DETACH classifier_db&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Detached classifier database&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Error detaching classifier database: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>

                    <span class="c1"># Close connection</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closed database connection&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing database connection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_maybe_migrate_json_to_db</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">DatabaseConnection</span><span class="p">,</span> <span class="n">existing_feedback</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Migrate data from JSON files to database if needed.&quot;&quot;&quot;</span>
        <span class="c1"># Check if there&#39;s existing data in the DB</span>
        <span class="k">if</span> <span class="n">existing_feedback</span> <span class="ow">or</span> <span class="n">preferences</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Check for JSON files</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_data_dir</span><span class="p">)</span>
        <span class="n">feedback_file</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;feedback.json&quot;</span>
        <span class="n">prefs_file</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;email_preferences.json&quot;</span>

        <span class="c1"># Migrate feedback data</span>
        <span class="k">if</span> <span class="n">feedback_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">feedback_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">feedback_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">feedback_data</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Migrating feedback data from </span><span class="si">{</span><span class="n">feedback_file</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save_feedback</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">feedback_data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error migrating feedback data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Migrate preferences data</span>
        <span class="k">if</span> <span class="n">prefs_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">prefs_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">prefs_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">prefs_data</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Migrating preferences data from </span><span class="si">{</span><span class="n">prefs_file</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save_preferences</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">prefs_data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error migrating preferences data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">FeedbackProcessor</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">Dewey (TUI)</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">dewey</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  <li><a href="../../../dewey.html">dewey</a><ul>
  <li><a href="../automation.html">dewey.core.automation</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Sloane Ortel.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>