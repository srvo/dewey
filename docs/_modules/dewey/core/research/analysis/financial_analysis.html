<!DOCTYPE html>

<html lang="en" data-content_root="../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dewey.core.research.analysis.financial_analysis &#8212; Dewey (TUI) 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for dewey.core.research.analysis.financial_analysis</h1><div class="highlight"><pre>
<span></span><span class="c1"># Refactored from: financial_analysis</span>
<span class="c1"># Date: 2025-03-16T16:19:10.702032</span>
<span class="c1"># Refactor Version: 1.0</span>
<span class="c1">#!/usr/bin/env python3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dewey.core.base_script</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseScript</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dewey.core.db.connection</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseConnection</span><span class="p">,</span> <span class="n">get_connection</span>


<div class="viewcode-block" id="FinancialAnalysis">
<a class="viewcode-back" href="../../../../../dewey.core.research.analysis.html#dewey.core.research.analysis.financial_analysis.FinancialAnalysis">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FinancialAnalysis</span><span class="p">(</span><span class="n">BaseScript</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyzes financial data to identify significant changes and material events for a given set of stocks.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FinancialAnalysis.__init__">
<a class="viewcode-back" href="../../../../../dewey.core.research.analysis.html#dewey.core.research.analysis.financial_analysis.FinancialAnalysis.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the FinancialAnalysis script with necessary configurations and connections.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Financial Analysis&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Analyzes financial data for significant changes and material events.&quot;</span><span class="p">,</span>
            <span class="n">config_section</span><span class="o">=</span><span class="s2">&quot;financial_analysis&quot;</span><span class="p">,</span>
            <span class="n">requires_db</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">enable_llm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FinancialAnalysis.sync_current_universe">
<a class="viewcode-back" href="../../../../../dewey.core.research.analysis.html#dewey.core.research.analysis.financial_analysis.FinancialAnalysis.sync_current_universe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sync_current_universe</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">local_conn</span><span class="p">:</span> <span class="n">DatabaseConnection</span><span class="p">,</span> <span class="n">md_conn</span><span class="p">:</span> <span class="n">DatabaseConnection</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sync current universe from MotherDuck to local DuckDB.</span>

<span class="sd">        Args:</span>
<span class="sd">            local_conn: Connection to the local DuckDB database.</span>
<span class="sd">            md_conn: Connection to the MotherDuck database.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If connection to MotherDuck fails.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">md_conn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No MotherDuck connection available, skipping sync&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get current universe from MotherDuck</span>
            <span class="n">stocks</span> <span class="o">=</span> <span class="n">md_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                SELECT</span>
<span class="sd">                    ticker, security_name as name, COALESCE(sector, category, &#39;Unknown&#39;) as sector, COALESCE(category, sector, &#39;Unknown&#39;) as industry</span>
<span class="sd">                FROM current_universe</span>
<span class="sd">                WHERE ticker IS NOT NULL</span>
<span class="sd">                    AND security_name IS NOT NULL</span>
<span class="sd">                    AND workflow IS NOT NULL  -- Only include stocks with a workflow</span>
<span class="sd">                    AND workflow != &#39;excluded&#39;  -- Exclude explicitly excluded stocks</span>
<span class="sd">                    AND workflow != &#39;ignore&#39;  -- Exclude ignored stocks</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fetchdf</span><span class="p">()</span>

            <span class="c1"># Create and populate table in local DuckDB</span>
            <span class="n">local_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                CREATE TABLE IF NOT EXISTS current_universe (</span>
<span class="sd">                    ticker VARCHAR PRIMARY KEY, name VARCHAR, sector VARCHAR, industry VARCHAR</span>
<span class="sd">                )</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Clear existing data</span>
            <span class="n">local_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM current_universe&quot;</span><span class="p">)</span>

            <span class="c1"># Insert new data</span>
            <span class="n">local_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO current_universe SELECT * FROM stocks&quot;</span><span class="p">)</span>
            <span class="n">local_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synced </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="si">}</span><span class="s2"> stocks to current_universe table&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error syncing current universe: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="FinancialAnalysis.get_current_universe">
<a class="viewcode-back" href="../../../../../dewey.core.research.analysis.html#dewey.core.research.analysis.financial_analysis.FinancialAnalysis.get_current_universe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_universe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current universe of stocks.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of dictionaries, each representing a stock with ticker, name, sector, and industry.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If database query fails.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">stocks_df</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    -- Get stocks from current universe and join with tracked_stocks to get their IDs</span>
<span class="sd">                    SELECT DISTINCT</span>
<span class="sd">                        cu.ticker, cu.name, cu.sector, cu.industry</span>
<span class="sd">                    FROM current_universe cu</span>
<span class="sd">                    JOIN tracked_stocks ts ON</span>
<span class="sd">                        -- Match either direct symbol or CIK-based symbol</span>
<span class="sd">                        ts.symbol = cu.ticker</span>
<span class="sd">                        OR ts.entity_id = REPLACE(ts.symbol, &#39;C&#39;, &#39;&#39;)</span>
<span class="sd">                    ORDER BY cu.sector, cu.industry, cu.ticker</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetchdf</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">stocks_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">stocks_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[]</span>

                <span class="n">stocks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">stocks_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">stocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;sector&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;industry&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;industry&quot;</span><span class="p">],</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                <span class="k">return</span> <span class="n">stocks</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting current universe: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="FinancialAnalysis.analyze_financial_changes">
<a class="viewcode-back" href="../../../../../dewey.core.research.analysis.html#dewey.core.research.analysis.financial_analysis.FinancialAnalysis.analyze_financial_changes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_financial_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze significant financial metric changes for a given ticker.</span>

<span class="sd">        Args:</span>
<span class="sd">            ticker: The stock ticker to analyze.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of dictionaries, each representing a significant financial metric change.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If database query fails.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get the last 2 months of financial metrics</span>
            <span class="n">two_months_ago</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">60</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    WITH MetricChanges AS (</span>
<span class="sd">                        SELECT</span>
<span class="sd">                            metric_name, value as current_value, LAG(value) OVER (PARTITION BY metric_name ORDER BY end_date) as prev_value, end_date, filed_date</span>
<span class="sd">                        FROM financial_metrics fm</span>
<span class="sd">                        JOIN tracked_stocks ts ON fm.stock_id = ts.id</span>
<span class="sd">                        JOIN current_universe cu ON</span>
<span class="sd">                            -- Match either direct symbol or CIK-based symbol</span>
<span class="sd">                            (ts.symbol = cu.ticker OR ts.entity_id = REPLACE(ts.symbol, &#39;C&#39;, &#39;&#39;))</span>
<span class="sd">                        WHERE cu.ticker = ?</span>
<span class="sd">                            AND end_date &gt;= ?</span>
<span class="sd">                            AND metric_namespace = &#39;us-gaap&#39;</span>
<span class="sd">                            AND metric_name IN (</span>
<span class="sd">                                &#39;Assets&#39;, &#39;Liabilities&#39;, &#39;Revenues&#39;, &#39;NetIncomeLoss&#39;, &#39;OperatingIncomeLoss&#39;, &#39;StockholdersEquity&#39;, &#39;CashAndCashEquivalentsAtCarryingValue&#39;</span>
<span class="sd">                            )</span>
<span class="sd">                        ORDER BY end_date DESC</span>
<span class="sd">                    )</span>
<span class="sd">                    SELECT</span>
<span class="sd">                        metric_name, current_value, prev_value, end_date, filed_date, CASE</span>
<span class="sd">                            WHEN prev_value = 0 OR prev_value IS NULL THEN NULL</span>
<span class="sd">                            ELSE ((current_value - prev_value) / ABS(prev_value)) * 100</span>
<span class="sd">                        END as pct_change</span>
<span class="sd">                    FROM MetricChanges</span>
<span class="sd">                    WHERE current_value IS NOT NULL</span>
<span class="sd">                        AND prev_value IS NOT NULL</span>
<span class="sd">                        AND ABS(CASE</span>
<span class="sd">                            WHEN prev_value = 0 OR prev_value IS NULL THEN 0</span>
<span class="sd">                            ELSE ((current_value - prev_value) / ABS(prev_value)) * 100</span>
<span class="sd">                        END) &gt; 20  -- Only show significant changes (&gt;20%)</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="n">two_months_ago</span><span class="p">],</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetchdf</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">metrics</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">metrics</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error analyzing financial changes for </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="FinancialAnalysis.analyze_material_events">
<a class="viewcode-back" href="../../../../../dewey.core.research.analysis.html#dewey.core.research.analysis.financial_analysis.FinancialAnalysis.analyze_material_events">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_material_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze material events from SEC filings for a given ticker.</span>

<span class="sd">        Args:</span>
<span class="sd">            ticker: The stock ticker to analyze.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of strings, each representing a material event.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If database query fails.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get recent filings</span>
            <span class="n">two_months_ago</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">60</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Look for significant events in financial metrics</span>
            <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_financial_changes</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>
                <span class="n">pct_change</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;pct_change&quot;</span><span class="p">]</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pct_change</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># Very significant change</span>
                    <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;MAJOR CHANGE: </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;increased&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">pct_change</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;decreased&#39;</span><span class="si">}</span><span class="s2"> by </span><span class="si">{</span><span class="n">pct_change</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% as of </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Significant change in </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;increased&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">pct_change</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;decreased&#39;</span><span class="si">}</span><span class="s2"> by </span><span class="si">{</span><span class="n">pct_change</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% as of </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Look for specific material events in filings</span>
            <span class="k">with</span> <span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">material_events</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    SELECT DISTINCT</span>
<span class="sd">                        form, filed_date, metric_name, value, start_date, end_date</span>
<span class="sd">                    FROM financial_metrics fm</span>
<span class="sd">                    JOIN tracked_stocks ts ON fm.stock_id = ts.id</span>
<span class="sd">                    JOIN current_universe cu ON</span>
<span class="sd">                        -- Match either direct symbol or CIK-based symbol</span>
<span class="sd">                        (ts.symbol = cu.ticker OR ts.entity_id = REPLACE(ts.symbol, &#39;C&#39;, &#39;&#39;))</span>
<span class="sd">                    WHERE cu.ticker = ?</span>
<span class="sd">                        AND filed_date &gt;= ?</span>
<span class="sd">                        AND form IN (&#39;8-K&#39;, &#39;10-Q&#39;, &#39;10-K&#39;)</span>
<span class="sd">                        AND (</span>
<span class="sd">                            metric_name LIKE &#39;%Restructuring%&#39;</span>
<span class="sd">                            OR metric_name LIKE &#39;%Acquisition%&#39;</span>
<span class="sd">                            OR metric_name LIKE &#39;%Impairment%&#39;</span>
<span class="sd">                            OR metric_name LIKE &#39;%Discontinued%&#39;</span>
<span class="sd">                            OR metric_name LIKE &#39;%LitigationSettlement%&#39;</span>
<span class="sd">                            OR metric_name LIKE &#39;%BusinessCombination%&#39;</span>
<span class="sd">                            OR metric_name LIKE &#39;%Merger%&#39;</span>
<span class="sd">                            OR metric_name LIKE &#39;%Disposal%&#39;</span>
<span class="sd">                            OR metric_name LIKE &#39;%Settlement%&#39;</span>
<span class="sd">                            OR metric_name LIKE &#39;%Termination%&#39;</span>
<span class="sd">                            OR metric_name LIKE &#39;%Severance%&#39;</span>
<span class="sd">                        )</span>
<span class="sd">                    ORDER BY filed_date DESC</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="n">two_months_ago</span><span class="p">],</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetchdf</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">material_events</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">material_events</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Material event (</span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> filed </span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;filed_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;metric_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

            <span class="k">return</span> <span class="n">events</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error analyzing material events for </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="FinancialAnalysis.run">
<a class="viewcode-back" href="../../../../../dewey.core.research.analysis.html#dewey.core.research.analysis.financial_analysis.FinancialAnalysis.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes the financial analysis process.</span>

<span class="sd">        This includes:</span>
<span class="sd">        1. Retrieving the current universe of stocks.</span>
<span class="sd">        2. Analyzing each stock for material events.</span>
<span class="sd">        3. Printing a summary of material findings.</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If any part of the analysis fails.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get current universe</span>
            <span class="n">stocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_universe</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="si">}</span><span class="s2"> stocks in current universe&quot;</span><span class="p">)</span>

            <span class="c1"># Analyze each stock</span>
            <span class="n">material_findings</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">stocks</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analyzing </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) - </span><span class="si">{</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;industry&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
                <span class="p">)</span>

                <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_material_events</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">events</span><span class="p">:</span>
                    <span class="n">material_findings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">stock</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;sector&quot;</span><span class="p">:</span> <span class="n">stock</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;industry&quot;</span><span class="p">:</span> <span class="n">stock</span><span class="p">[</span><span class="s2">&quot;industry&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;events&quot;</span><span class="p">:</span> <span class="n">events</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

            <span class="c1"># Print summary of material findings</span>
            <span class="k">if</span> <span class="n">material_findings</span><span class="p">:</span>
                <span class="c1"># Group by sector</span>
                <span class="n">by_sector</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">finding</span> <span class="ow">in</span> <span class="n">material_findings</span><span class="p">:</span>
                    <span class="n">sector</span> <span class="o">=</span> <span class="n">finding</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sector</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">by_sector</span><span class="p">:</span>
                        <span class="n">by_sector</span><span class="p">[</span><span class="n">sector</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">by_sector</span><span class="p">[</span><span class="n">sector</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">finding</span><span class="p">)</span>

                <span class="c1"># Print findings by sector</span>
                <span class="k">for</span> <span class="n">sector</span><span class="p">,</span> <span class="n">findings</span> <span class="ow">in</span> <span class="n">by_sector</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">finding</span> <span class="ow">in</span> <span class="n">findings</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">finding</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">finding</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No material findings to report&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis completed successfully&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during analysis: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>
</div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../../../dewey.core.research.analysis.html#dewey.core.research.analysis.financial_analysis.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main entry point for the financial analysis script.&quot;&quot;&quot;</span>
    <span class="n">analysis</span> <span class="o">=</span> <span class="n">FinancialAnalysis</span><span class="p">()</span>
    <span class="n">analysis</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../index.html">Dewey (TUI)</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../../index.html">Module code</a><ul>
  <li><a href="../../../../dewey.html">dewey</a><ul>
  <li><a href="../../research.html">dewey.core.research</a><ul>
  <li><a href="../analysis.html">dewey.core.research.analysis</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Sloane Ortel.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>