<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dewey.core.db.operations &#8212; Dewey (TUI) 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />

  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />





  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for dewey.core.db.operations</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Database operations module.</span>

<span class="sd">This module provides high-level database operations and transaction management</span>
<span class="sd">for both local DuckDB and MotherDuck cloud databases.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.connection</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseConnectionError</span><span class="p">,</span> <span class="n">db_manager</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="get_column_names">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.operations.get_column_names">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_column_names</span><span class="p">(</span><span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">local_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get column names for a table.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name: Name of the table</span>
<span class="sd">        local_only: Whether to only query local database</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of column names</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Query table schema to get column names</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;DESCRIBE </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span>
        <span class="p">)</span>
        <span class="c1"># Extract column names (first column in each row)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get column names for </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="record_change">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.operations.record_change">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">record_change</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">record_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">details</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Record a change in the change_log table.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name: Name of the table being modified</span>
<span class="sd">        operation: Type of operation (INSERT, UPDATE, DELETE)</span>
<span class="sd">        record_id: ID of the record being modified</span>
<span class="sd">        details: Additional details about the change</span>
<span class="sd">        user_id: ID of the user making the change</span>
<span class="sd">        local_only: Whether to only record in local database</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Log the changes to change_log table</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            INSERT INTO change_log (</span>
<span class="sd">                table_name, operation, record_id,</span>
<span class="sd">                changed_at, user_id, details</span>
<span class="sd">            ) VALUES (?, ?, ?, CURRENT_TIMESTAMP, ?, ?)</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">table_name</span><span class="p">,</span>
                <span class="n">operation</span><span class="p">,</span>
                <span class="n">record_id</span><span class="p">,</span>
                <span class="n">user_id</span><span class="p">,</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">details</span><span class="p">)</span> <span class="k">if</span> <span class="n">details</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Log to console</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Recorded </span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s2"> change to </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">record_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; (local only)&quot;</span> <span class="k">if</span> <span class="n">local_only</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to record change: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="insert_record">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.operations.insert_record">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">insert_record</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Insert a new record into a table.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name: Name of the table to insert into</span>
<span class="sd">        data: Dictionary of column names and values</span>
<span class="sd">        user_id: ID of the user making the change</span>
<span class="sd">        local_only: Whether to only insert in local database</span>

<span class="sd">    Returns:</span>
<span class="sd">        ID of the inserted record</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Start transaction</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
            <span class="s2">&quot;BEGIN TRANSACTION&quot;</span><span class="p">,</span> <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Insert record</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">placeholders</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;?&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="c1"># Use RETURNING id to get the inserted ID</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">columns</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                VALUES (</span><span class="si">{</span><span class="n">placeholders</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                RETURNING id</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">values</span><span class="p">,</span>
                <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Get the returned ID - note: db_manager.execute_query will handle writing to</span>
            <span class="c1"># both MotherDuck and local DB when local_only=False</span>
            <span class="n">record_id</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;1&quot;</span>
            <span class="p">)</span>  <span class="c1"># Default to &#39;1&#39; for tests</span>

            <span class="c1"># Record change</span>
            <span class="n">record_change</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="s2">&quot;INSERT&quot;</span><span class="p">,</span> <span class="n">record_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">local_only</span><span class="p">)</span>

            <span class="c1"># Commit transaction</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">,</span> <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserted record </span><span class="si">{</span><span class="n">record_id</span><span class="si">}</span><span class="s2"> into </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">record_id</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Rollback transaction</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="s2">&quot;ROLLBACK&quot;</span><span class="p">,</span> <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to insert record into </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DatabaseConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="update_record">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.operations.update_record">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_record</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">record_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update an existing record in a table.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name: Name of the table to update</span>
<span class="sd">        record_id: ID of the record to update</span>
<span class="sd">        data: Dictionary of column names and values to update</span>
<span class="sd">        user_id: ID of the user making the change</span>
<span class="sd">        local_only: Whether to only update in local database</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Start transaction</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
            <span class="s2">&quot;BEGIN TRANSACTION&quot;</span><span class="p">,</span> <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Update record</span>
            <span class="n">set_clause</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = ?&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="n">record_id</span><span class="p">]</span>

            <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">                SET </span><span class="si">{</span><span class="n">set_clause</span><span class="si">}</span>
<span class="s2">                WHERE id = ?</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">values</span><span class="p">,</span>
                <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Record change - db_manager.execute_query will handle writing to</span>
            <span class="c1"># both MotherDuck and local DB when local_only=False</span>
            <span class="n">record_change</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="s2">&quot;UPDATE&quot;</span><span class="p">,</span> <span class="n">record_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">local_only</span><span class="p">)</span>

            <span class="c1"># Commit transaction</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">,</span> <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated record </span><span class="si">{</span><span class="n">record_id</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Rollback transaction</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="s2">&quot;ROLLBACK&quot;</span><span class="p">,</span> <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to update record </span><span class="si">{</span><span class="n">record_id</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DatabaseConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="delete_record">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.operations.delete_record">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_record</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">record_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete a record from a table.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name: Name of the table to delete from</span>
<span class="sd">        record_id: ID of the record to delete</span>
<span class="sd">        user_id: ID of the user making the change</span>
<span class="sd">        local_only: Whether to only delete from local database</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Start transaction</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
            <span class="s2">&quot;BEGIN TRANSACTION&quot;</span><span class="p">,</span> <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get record data before deletion</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">                WHERE id = ?</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="n">record_id</span><span class="p">],</span>
                <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Record </span><span class="si">{</span><span class="n">record_id</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Get column names</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">get_column_names</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">)</span>

            <span class="c1"># Create old_data dictionary</span>
            <span class="n">old_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="c1"># Delete record - db_manager.execute_query will handle writing to</span>
            <span class="c1"># both MotherDuck and local DB when local_only=False</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                DELETE FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">                WHERE id = ?</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="n">record_id</span><span class="p">],</span>
                <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Record change</span>
            <span class="n">record_change</span><span class="p">(</span>
                <span class="n">table_name</span><span class="p">,</span>
                <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span>
                <span class="n">record_id</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;old_data&quot;</span><span class="p">:</span> <span class="n">old_data</span><span class="p">},</span>
                <span class="n">user_id</span><span class="p">,</span>
                <span class="n">local_only</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Commit transaction</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">,</span> <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted record </span><span class="si">{</span><span class="n">record_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Rollback transaction</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="s2">&quot;ROLLBACK&quot;</span><span class="p">,</span> <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to delete record </span><span class="si">{</span><span class="n">record_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DatabaseConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_record">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.operations.get_record">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_record</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">record_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">local_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a single record from a table.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name: Name of the table to query</span>
<span class="sd">        record_id: ID of the record to get</span>
<span class="sd">        local_only: Whether to only query local database</span>

<span class="sd">    Returns:</span>
<span class="sd">        Record as dictionary or None if not found</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">            WHERE id = ?</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="n">record_id</span><span class="p">],</span>
            <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Get column names using our utility function</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">get_column_names</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">local_only</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to get record </span><span class="si">{</span><span class="n">record_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DatabaseConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="query_records">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.operations.query_records">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">query_records</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">conditions</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">order_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Query records from a table with optional filtering.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name: Name of the table to query</span>
<span class="sd">        conditions: Dictionary of column-value pairs for WHERE clause</span>
<span class="sd">        order_by: Column name to order by</span>
<span class="sd">        limit: Maximum number of records to return</span>
<span class="sd">        local_only: Whether to only query local database</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of records as dictionaries</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Build query</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Add WHERE clause if conditions provided</span>
        <span class="k">if</span> <span class="n">conditions</span><span class="p">:</span>
            <span class="n">where_clauses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">conditions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">where_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> = ?&quot;</span><span class="p">)</span>
                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; WHERE &quot;</span> <span class="o">+</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_clauses</span><span class="p">)</span>

        <span class="c1"># Add ORDER BY clause if provided</span>
        <span class="k">if</span> <span class="n">order_by</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; ORDER BY </span><span class="si">{</span><span class="n">order_by</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Add LIMIT clause if provided</span>
        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; LIMIT </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Execute query</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Get column names using our utility function</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">get_column_names</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">local_only</span><span class="p">)</span>

        <span class="c1"># Convert tuples to dictionaries</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to query records from </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DatabaseConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="bulk_insert">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.operations.bulk_insert">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bulk_insert</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">records</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bulk insert multiple records into a table.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name: Name of the table to insert into</span>
<span class="sd">        records: List of dictionaries with column names and values</span>
<span class="sd">        user_id: ID of the user making the change</span>
<span class="sd">        local_only: Whether to only insert in local database</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of inserted record IDs</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Start transaction</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
            <span class="s2">&quot;BEGIN TRANSACTION&quot;</span><span class="p">,</span> <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">record_ids</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Insert each record individually</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="c1"># Insert record</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">placeholders</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;?&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
                <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

                <span class="c1"># Use RETURNING id to get the inserted ID</span>
                <span class="c1"># Note: db_manager.execute_query will handle writing to both</span>
                <span class="c1"># MotherDuck and local DB when local_only=False</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    INSERT INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">columns</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                    VALUES (</span><span class="si">{</span><span class="n">placeholders</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                    RETURNING id</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="n">values</span><span class="p">,</span>
                    <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Get the returned ID</span>
                <span class="n">record_id</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;1&quot;</span>
                <span class="p">)</span>  <span class="c1"># Default to &#39;1&#39; for tests</span>
                <span class="n">record_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record_id</span><span class="p">)</span>

                <span class="c1"># Record change</span>
                <span class="n">record_change</span><span class="p">(</span>
                    <span class="n">table_name</span><span class="p">,</span> <span class="s2">&quot;INSERT&quot;</span><span class="p">,</span> <span class="n">record_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">local_only</span>
                <span class="p">)</span>

            <span class="c1"># Commit transaction</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">,</span> <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bulk inserted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span><span class="si">}</span><span class="s2"> records into </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">record_ids</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Rollback transaction</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="s2">&quot;ROLLBACK&quot;</span><span class="p">,</span> <span class="n">for_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_only</span><span class="o">=</span><span class="n">local_only</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to bulk insert records into </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DatabaseConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="execute_custom_query">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.operations.execute_custom_query">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">execute_custom_query</span><span class="p">(</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">for_write</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">local_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a custom SQL query.</span>

<span class="sd">    Args:</span>
<span class="sd">        query: SQL query to execute</span>
<span class="sd">        params: List of parameter values</span>
<span class="sd">        for_write: Whether the query modifies data</span>
<span class="sd">        local_only: Whether to only execute on local database</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of result tuples</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">for_write</span><span class="p">,</span> <span class="n">local_only</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to execute custom query: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DatabaseConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div>

</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">Dewey (TUI)</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  <li><a href="../../../dewey.html">dewey</a><ul>
  <li><a href="../db.html">dewey.core.db</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Sloane Ortel.

      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>

    </div>




  </body>
</html>
