<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dewey.core.db.schema &#8212; Dewey (TUI) 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />

  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />





  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for dewey.core.db.schema</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Schema management module.</span>

<span class="sd">This module handles database schema creation, migrations, and versioning</span>
<span class="sd">for PostgreSQL databases.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.connection</span><span class="w"> </span><span class="kn">import</span> <span class="n">db_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dewey.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseConnectionError</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># List of all tables that should exist in the database</span>
<span class="n">TABLES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;emails&quot;</span><span class="p">,</span>
    <span class="s2">&quot;email_analyses&quot;</span><span class="p">,</span>
    <span class="s2">&quot;company_context&quot;</span><span class="p">,</span>
    <span class="s2">&quot;documents&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tasks&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ai_feedback&quot;</span><span class="p">,</span>
    <span class="s2">&quot;schema_versions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;change_log&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sync_status&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sync_conflicts&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Schema version tracking table (PostgreSQL compatible)</span>
<span class="n">SCHEMA_VERSION_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE IF NOT EXISTS schema_versions (</span>
<span class="s2">    id SERIAL PRIMARY KEY,</span>
<span class="s2">    version INTEGER NOT NULL,</span>
<span class="s2">    applied_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">    description TEXT,</span>
<span class="s2">    checksum VARCHAR(64),</span>
<span class="s2">    status TEXT DEFAULT &#39;pending&#39;,</span>
<span class="s2">    error_message TEXT</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Change tracking tables (PostgreSQL compatible)</span>
<span class="n">CHANGE_LOG_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE IF NOT EXISTS change_log (</span>
<span class="s2">    id SERIAL PRIMARY KEY,</span>
<span class="s2">    table_name VARCHAR NOT NULL,</span>
<span class="s2">    operation VARCHAR NOT NULL,</span>
<span class="s2">    record_id VARCHAR NOT NULL,</span>
<span class="s2">    changed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">    user_id VARCHAR,</span>
<span class="s2">    details JSONB</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">SYNC_STATUS_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE IF NOT EXISTS sync_status (</span>
<span class="s2">    id SERIAL PRIMARY KEY,</span>
<span class="s2">    sync_time TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">    status VARCHAR NOT NULL,</span>
<span class="s2">    message TEXT,</span>
<span class="s2">    details JSONB</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">SYNC_CONFLICTS_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE IF NOT EXISTS sync_conflicts (</span>
<span class="s2">    id SERIAL PRIMARY KEY,</span>
<span class="s2">    table_name VARCHAR NOT NULL,</span>
<span class="s2">    record_id VARCHAR NOT NULL,</span>
<span class="s2">    operation VARCHAR NOT NULL,</span>
<span class="s2">    error_message TEXT,</span>
<span class="s2">    sync_time TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">    resolved BOOLEAN DEFAULT FALSE,</span>
<span class="s2">    resolution_time TIMESTAMP WITH TIME ZONE,</span>
<span class="s2">    resolution_details JSONB</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Core tables (PostgreSQL compatible)</span>
<span class="n">EMAILS_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE IF NOT EXISTS emails (</span>
<span class="s2">    id VARCHAR PRIMARY KEY,</span>
<span class="s2">    thread_id VARCHAR,</span>
<span class="s2">    subject VARCHAR,</span>
<span class="s2">    snippet VARCHAR,</span>
<span class="s2">    body_text TEXT,</span>
<span class="s2">    body_html TEXT,</span>
<span class="s2">    from_name VARCHAR,</span>
<span class="s2">    from_email VARCHAR,</span>
<span class="s2">    to_addresses JSONB,</span>
<span class="s2">    cc_addresses JSONB,</span>
<span class="s2">    bcc_addresses JSONB,</span>
<span class="s2">    received_date TIMESTAMP WITH TIME ZONE,</span>
<span class="s2">    labels JSONB,</span>
<span class="s2">    size_estimate INTEGER,</span>
<span class="s2">    is_draft BOOLEAN,</span>
<span class="s2">    is_sent BOOLEAN,</span>
<span class="s2">    is_read BOOLEAN,</span>
<span class="s2">    is_starred BOOLEAN,</span>
<span class="s2">    is_trashed BOOLEAN,</span>
<span class="s2">    attachments JSONB,</span>
<span class="s2">    raw_data JSONB,</span>
<span class="s2">    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">    error_message VARCHAR,</span>
<span class="s2">    status VARCHAR DEFAULT &#39;new&#39;</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">EMAIL_ANALYSES_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE IF NOT EXISTS email_analyses (</span>
<span class="s2">    msg_id VARCHAR PRIMARY KEY,</span>
<span class="s2">    thread_id VARCHAR,</span>
<span class="s2">    subject VARCHAR,</span>
<span class="s2">    from_address VARCHAR,</span>
<span class="s2">    analysis_date TIMESTAMP WITH TIME ZONE,</span>
<span class="s2">    raw_analysis JSONB,</span>
<span class="s2">    automation_score FLOAT,</span>
<span class="s2">    content_value FLOAT,</span>
<span class="s2">    human_interaction FLOAT,</span>
<span class="s2">    time_value FLOAT,</span>
<span class="s2">    business_impact FLOAT,</span>
<span class="s2">    uncertainty_score FLOAT,</span>
<span class="s2">    metadata JSONB,</span>
<span class="s2">    priority INTEGER,</span>
<span class="s2">    label_ids JSONB,</span>
<span class="s2">    snippet TEXT,</span>
<span class="s2">    internal_date BIGINT,</span>
<span class="s2">    size_estimate INTEGER,</span>
<span class="s2">    message_parts JSONB,</span>
<span class="s2">    draft_id VARCHAR,</span>
<span class="s2">    draft_message JSONB,</span>
<span class="s2">    attachments JSONB</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">COMPANY_CONTEXT_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE IF NOT EXISTS company_context (</span>
<span class="s2">    id VARCHAR PRIMARY KEY,</span>
<span class="s2">    company_name VARCHAR NOT NULL,</span>
<span class="s2">    context_text TEXT,</span>
<span class="s2">    source VARCHAR,</span>
<span class="s2">    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">    metadata JSONB</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DOCUMENTS_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE IF NOT EXISTS documents (</span>
<span class="s2">    id VARCHAR PRIMARY KEY,</span>
<span class="s2">    title VARCHAR,</span>
<span class="s2">    content TEXT,</span>
<span class="s2">    content_type VARCHAR,</span>
<span class="s2">    metadata JSONB,</span>
<span class="s2">    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">    status VARCHAR DEFAULT &#39;new&#39;</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TASKS_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE IF NOT EXISTS tasks (</span>
<span class="s2">    id VARCHAR PRIMARY KEY,</span>
<span class="s2">    title VARCHAR NOT NULL,</span>
<span class="s2">    description TEXT,</span>
<span class="s2">    status VARCHAR DEFAULT &#39;pending&#39;,</span>
<span class="s2">    priority INTEGER DEFAULT 0,</span>
<span class="s2">    due_date TIMESTAMP WITH TIME ZONE,</span>
<span class="s2">    completed_at TIMESTAMP WITH TIME ZONE,</span>
<span class="s2">    metadata JSONB,</span>
<span class="s2">    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">AI_FEEDBACK_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE IF NOT EXISTS ai_feedback (</span>
<span class="s2">    id VARCHAR PRIMARY KEY,</span>
<span class="s2">    source_table VARCHAR NOT NULL,</span>
<span class="s2">    source_id VARCHAR NOT NULL,</span>
<span class="s2">    feedback_type VARCHAR NOT NULL,</span>
<span class="s2">    feedback_content JSONB NOT NULL,</span>
<span class="s2">    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">    resolved_at TIMESTAMP WITH TIME ZONE,</span>
<span class="s2">    resolution_details JSONB,</span>
<span class="s2">    resolution_status VARCHAR DEFAULT &#39;pending&#39;</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="initialize_schema">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema.initialize_schema">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">initialize_schema</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the database schema by creating all required tables.</span>

<span class="sd">    This will ensure all tables defined in the schema are created if they don&#39;t exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># First create schema version tracking table</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">SCHEMA_VERSION_TABLE</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Schema version table initialized&quot;</span><span class="p">)</span>

        <span class="c1"># Create change tracking tables</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">CHANGE_LOG_TABLE</span><span class="p">)</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">SYNC_STATUS_TABLE</span><span class="p">)</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">SYNC_CONFLICTS_TABLE</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Change tracking tables initialized&quot;</span><span class="p">)</span>

        <span class="c1"># Create core tables</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">EMAILS_TABLE</span><span class="p">)</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">EMAIL_ANALYSES_TABLE</span><span class="p">)</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">COMPANY_CONTEXT_TABLE</span><span class="p">)</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">DOCUMENTS_TABLE</span><span class="p">)</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">TASKS_TABLE</span><span class="p">)</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">AI_FEEDBACK_TABLE</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Core tables initialized&quot;</span><span class="p">)</span>

        <span class="c1"># If no version record exists, insert initial version</span>
        <span class="n">current_version</span> <span class="o">=</span> <span class="n">get_current_version</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">current_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                INSERT INTO schema_versions (version, description, status)</span>
<span class="sd">                VALUES (1, &#39;Initial schema creation&#39;, &#39;applied&#39;)</span>
<span class="sd">                &quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set initial schema version to 1&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize schema: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="get_current_version">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema.get_current_version">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_current_version</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the current schema version from the database.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The current schema version, or 0 if no version exists</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT MAX(version) FROM schema_versions</span>
<span class="sd">            WHERE status = &#39;applied&#39;</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get current schema version: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>



<div class="viewcode-block" id="apply_migration">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema.apply_migration">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_migration</span><span class="p">(</span><span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sql_statements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply a database migration.</span>

<span class="sd">    Args:</span>
<span class="sd">        version: The version number to migrate to</span>
<span class="sd">        description: Description of the migration</span>
<span class="sd">        sql_statements: List of SQL statements to execute</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if migration was successful, False otherwise</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">get_current_version</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;=</span> <span class="n">current_version</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Migration to version </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2"> skipped (current: </span><span class="si">{</span><span class="n">current_version</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Record migration attempt</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            INSERT INTO schema_versions (version, description, status)</span>
<span class="sd">            VALUES (%s, %s, %s)</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="s2">&quot;pending&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Execute each SQL statement</span>
        <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">sql_statements</span><span class="p">:</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>

        <span class="c1"># Update migration status</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            UPDATE schema_versions</span>
<span class="sd">            SET status = &#39;applied&#39;, applied_at = CURRENT_TIMESTAMP</span>
<span class="sd">            WHERE version = %s</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">version</span><span class="p">,),</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully applied migration to version </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Record error</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            UPDATE schema_versions</span>
<span class="sd">            SET status = &#39;failed&#39;, error_message = %s</span>
<span class="sd">            WHERE version = %s</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">version</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to apply migration to version </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="verify_schema_consistency">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema.verify_schema_consistency">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">verify_schema_consistency</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify schema consistency using PostgreSQL information schema.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get table list from PostgreSQL</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT table_name</span>
<span class="s2">            FROM information_schema.tables</span>
<span class="s2">            WHERE table_schema = &#39;public&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">postgres_tables</span> <span class="o">=</span> <span class="p">{</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Compare against expected tables</span>
        <span class="n">expected_tables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;emails&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email_analyses&quot;</span><span class="p">,</span>
            <span class="s2">&quot;company_context&quot;</span><span class="p">,</span>
            <span class="s2">&quot;documents&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tasks&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ai_feedback&quot;</span><span class="p">,</span>
            <span class="s2">&quot;schema_versions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;change_log&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sync_status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sync_conflicts&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">missing_tables</span> <span class="o">=</span> <span class="n">expected_tables</span> <span class="o">-</span> <span class="n">postgres_tables</span>
        <span class="k">if</span> <span class="n">missing_tables</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatabaseConnectionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing tables: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_tables</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Verify table structures</span>
        <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">expected_tables</span><span class="p">:</span>
            <span class="c1"># Get column info from PostgreSQL</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT column_name, data_type, is_nullable</span>
<span class="s2">                FROM information_schema.columns</span>
<span class="s2">                WHERE table_name = &#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">                ORDER BY ordinal_position</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># Compare with expected schema (would need schema definition)</span>
            <span class="c1"># This is simplified - would need actual schema definition to compare</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatabaseConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Table </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> exists but has no columns&quot;</span>
                <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Schema consistency verified&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Schema consistency check failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;TABLES&quot;</span><span class="p">,</span>
    <span class="s2">&quot;initialize_schema&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_current_version&quot;</span><span class="p">,</span>
    <span class="s2">&quot;apply_migration&quot;</span><span class="p">,</span>
    <span class="s2">&quot;verify_schema_consistency&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">Dewey (TUI)</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  <li><a href="../../../dewey.html">dewey</a><ul>
  <li><a href="../db.html">dewey.core.db</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Sloane Ortel.

      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>

    </div>




  </body>
</html>
