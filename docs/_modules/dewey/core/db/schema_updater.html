<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dewey.core.db.schema_updater &#8212; Dewey (TUI) 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />

  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />





  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for dewey.core.db.schema_updater</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;MotherDuck Schema Extractor</span>

<span class="sd">This script connects to MotherDuck, extracts the database schema,</span>
<span class="sd">and updates the SQLAlchemy models in models.py file.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">keyword</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">duckdb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

<span class="c1"># Add project root to path if running this script directly</span>
<span class="n">script_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span>
<span class="n">project_root</span> <span class="o">=</span> <span class="n">script_dir</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">project_root</span><span class="p">))</span>

<span class="c1"># Set file paths</span>
<span class="n">CONFIG_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/Users/srvo/dewey/config/dewey.yaml&quot;</span><span class="p">)</span>
<span class="n">MODELS_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/Users/srvo/dewey/src/dewey/core/db/models.py&quot;</span><span class="p">)</span>

<span class="c1"># DuckDB to SQLAlchemy type mapping</span>
<span class="n">DUCKDB_TO_SQLALCHEMY_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;INTEGER&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.Integer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BIGINT&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.BigInteger&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SMALLINT&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.SmallInteger&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TINYINT&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.SmallInteger&quot;</span><span class="p">,</span>
    <span class="s2">&quot;UBIGINT&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.BigInteger&quot;</span><span class="p">,</span>
    <span class="s2">&quot;UINTEGER&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.Integer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;USMALLINT&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.SmallInteger&quot;</span><span class="p">,</span>
    <span class="s2">&quot;UTINYINT&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.SmallInteger&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DECIMAL&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.DECIMAL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FLOAT&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.Float&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DOUBLE&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.Float&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VARCHAR&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.String&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CHAR&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.CHAR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TEXT&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.Text&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BOOLEAN&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.Boolean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DATE&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.Date&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TIME&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.Time&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TIMESTAMP&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.DateTime&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TIMESTAMP WITH TIME ZONE&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.DateTime(timezone=True)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BLOB&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.LargeBinary&quot;</span><span class="p">,</span>
    <span class="s2">&quot;UUID&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.String&quot;</span><span class="p">,</span>
    <span class="s2">&quot;JSON&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.JSON&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ENUM&quot;</span><span class="p">:</span> <span class="s2">&quot;sa.Enum&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Add list of Python keywords and other problematic identifiers</span>
<span class="n">PYTHON_KEYWORDS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">keyword</span><span class="o">.</span><span class="n">kwlist</span><span class="p">)</span>
<span class="c1"># Add additional problematic identifiers</span>
<span class="n">PROBLEMATIC_IDENTIFIERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;yield&quot;</span><span class="p">:</span> <span class="s2">&quot;yield_value&quot;</span><span class="p">,</span>
    <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;class_type&quot;</span><span class="p">,</span>
    <span class="s2">&quot;global&quot;</span><span class="p">:</span> <span class="s2">&quot;global_flag&quot;</span><span class="p">,</span>
    <span class="s2">&quot;import&quot;</span><span class="p">:</span> <span class="s2">&quot;import_flag&quot;</span><span class="p">,</span>
    <span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="s2">&quot;return_value&quot;</span><span class="p">,</span>
    <span class="s2">&quot;break&quot;</span><span class="p">:</span> <span class="s2">&quot;break_flag&quot;</span><span class="p">,</span>
    <span class="s2">&quot;continue&quot;</span><span class="p">:</span> <span class="s2">&quot;continue_flag&quot;</span><span class="p">,</span>
    <span class="s2">&quot;for&quot;</span><span class="p">:</span> <span class="s2">&quot;for_loop&quot;</span><span class="p">,</span>
    <span class="s2">&quot;while&quot;</span><span class="p">:</span> <span class="s2">&quot;while_loop&quot;</span><span class="p">,</span>
    <span class="s2">&quot;try&quot;</span><span class="p">:</span> <span class="s2">&quot;try_block&quot;</span><span class="p">,</span>
    <span class="s2">&quot;except&quot;</span><span class="p">:</span> <span class="s2">&quot;except_handler&quot;</span><span class="p">,</span>
    <span class="s2">&quot;finally&quot;</span><span class="p">:</span> <span class="s2">&quot;finally_block&quot;</span><span class="p">,</span>
    <span class="s2">&quot;with&quot;</span><span class="p">:</span> <span class="s2">&quot;with_context&quot;</span><span class="p">,</span>
    <span class="s2">&quot;as&quot;</span><span class="p">:</span> <span class="s2">&quot;as_alias&quot;</span><span class="p">,</span>
    <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;from_source&quot;</span><span class="p">,</span>
    <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="s2">&quot;in_container&quot;</span><span class="p">,</span>
    <span class="s2">&quot;is&quot;</span><span class="p">:</span> <span class="s2">&quot;is_equal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lambda&quot;</span><span class="p">:</span> <span class="s2">&quot;lambda_func&quot;</span><span class="p">,</span>
    <span class="s2">&quot;def&quot;</span><span class="p">:</span> <span class="s2">&quot;def_function&quot;</span><span class="p">,</span>
    <span class="s2">&quot;if&quot;</span><span class="p">:</span> <span class="s2">&quot;if_condition&quot;</span><span class="p">,</span>
    <span class="s2">&quot;else&quot;</span><span class="p">:</span> <span class="s2">&quot;else_clause&quot;</span><span class="p">,</span>
    <span class="s2">&quot;elif&quot;</span><span class="p">:</span> <span class="s2">&quot;elif_clause&quot;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="sanitize_identifier">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.sanitize_identifier">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sanitize_identifier</span><span class="p">(</span><span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sanitize an identifier to make it a valid Python identifier.</span>
<span class="sd">    - Replace spaces with underscores</span>
<span class="sd">    - Handle reserved keywords</span>
<span class="sd">    - Handle identifiers starting with numbers</span>
<span class="sd">    - Handle special characters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Replace spaces with underscores</span>
    <span class="n">sanitized</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>

    <span class="c1"># Handle identifiers starting with numbers</span>
    <span class="k">if</span> <span class="n">sanitized</span> <span class="ow">and</span> <span class="n">sanitized</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="c1"># Map common patterns like &#39;5yr&#39; to &#39;five_yr&#39;</span>
        <span class="n">number_words</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="s2">&quot;zero&quot;</span><span class="p">,</span>
            <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;one&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;two&quot;</span><span class="p">,</span>
            <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;three&quot;</span><span class="p">,</span>
            <span class="s2">&quot;4&quot;</span><span class="p">:</span> <span class="s2">&quot;four&quot;</span><span class="p">,</span>
            <span class="s2">&quot;5&quot;</span><span class="p">:</span> <span class="s2">&quot;five&quot;</span><span class="p">,</span>
            <span class="s2">&quot;6&quot;</span><span class="p">:</span> <span class="s2">&quot;six&quot;</span><span class="p">,</span>
            <span class="s2">&quot;7&quot;</span><span class="p">:</span> <span class="s2">&quot;seven&quot;</span><span class="p">,</span>
            <span class="s2">&quot;8&quot;</span><span class="p">:</span> <span class="s2">&quot;eight&quot;</span><span class="p">,</span>
            <span class="s2">&quot;9&quot;</span><span class="p">:</span> <span class="s2">&quot;nine&quot;</span><span class="p">,</span>
            <span class="s2">&quot;10&quot;</span><span class="p">:</span> <span class="s2">&quot;ten&quot;</span><span class="p">,</span>
            <span class="s2">&quot;11&quot;</span><span class="p">:</span> <span class="s2">&quot;eleven&quot;</span><span class="p">,</span>
            <span class="s2">&quot;12&quot;</span><span class="p">:</span> <span class="s2">&quot;twelve&quot;</span><span class="p">,</span>
            <span class="s2">&quot;15&quot;</span><span class="p">:</span> <span class="s2">&quot;fifteen&quot;</span><span class="p">,</span>
            <span class="s2">&quot;20&quot;</span><span class="p">:</span> <span class="s2">&quot;twenty&quot;</span><span class="p">,</span>
            <span class="s2">&quot;30&quot;</span><span class="p">:</span> <span class="s2">&quot;thirty&quot;</span><span class="p">,</span>
            <span class="s2">&quot;50&quot;</span><span class="p">:</span> <span class="s2">&quot;fifty&quot;</span><span class="p">,</span>
            <span class="s2">&quot;100&quot;</span><span class="p">:</span> <span class="s2">&quot;one_hundred&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Try to find the longest matching number prefix</span>
        <span class="k">for</span> <span class="n">num_str</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">number_words</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sanitized</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">num_str</span><span class="p">):</span>
                <span class="n">sanitized</span> <span class="o">=</span> <span class="n">number_words</span><span class="p">[</span><span class="n">num_str</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">sanitized</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">num_str</span><span class="p">)</span> <span class="p">:]</span>
                <span class="k">break</span>

        <span class="c1"># If no specific match was found but still starts with a digit</span>
        <span class="k">if</span> <span class="n">sanitized</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">sanitized</span> <span class="o">=</span> <span class="s2">&quot;n&quot;</span> <span class="o">+</span> <span class="n">sanitized</span>

    <span class="c1"># Replace special characters with underscores (including &amp;)</span>
    <span class="n">sanitized</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^\w_]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">sanitized</span><span class="p">)</span>

    <span class="c1"># Check if it&#39;s a Python keyword or problematic identifier</span>
    <span class="k">if</span> <span class="n">sanitized</span> <span class="ow">in</span> <span class="n">PYTHON_KEYWORDS</span> <span class="ow">or</span> <span class="n">sanitized</span> <span class="ow">in</span> <span class="n">PROBLEMATIC_IDENTIFIERS</span><span class="p">:</span>
        <span class="n">sanitized</span> <span class="o">=</span> <span class="n">PROBLEMATIC_IDENTIFIERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sanitized</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sanitized</span><span class="si">}</span><span class="s2">_val&quot;</span><span class="p">)</span>

    <span class="c1"># Check for SQLAlchemy reserved attributes</span>
    <span class="n">SQLALCHEMY_RESERVED</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">,</span>
        <span class="s2">&quot;query&quot;</span><span class="p">,</span>
        <span class="s2">&quot;registry&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__init__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__table__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__tablename__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__mapper_args__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__dict__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__weakref__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__module__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__annotations__&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">sanitized</span> <span class="ow">in</span> <span class="n">SQLALCHEMY_RESERVED</span><span class="p">:</span>
        <span class="n">sanitized</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sanitized</span><span class="si">}</span><span class="s2">_col&quot;</span>

    <span class="k">return</span> <span class="n">sanitized</span></div>



<div class="viewcode-block" id="load_env_variables">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.load_env_variables">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_env_variables</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load environment variables from .env file.&quot;&quot;&quot;</span>
    <span class="n">env_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/Users/srvo/dewey/.env&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded environment variables from .env file&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_config">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.load_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load configuration from dewey.yaml.&quot;&quot;&quot;</span>
    <span class="c1"># First load environment variables</span>
    <span class="n">load_env_variables</span><span class="p">()</span>

    <span class="c1"># Check in home directory</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;dewey.yaml&quot;</span>

    <span class="c1"># Check in /etc</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/etc/dewey.yaml&quot;</span><span class="p">)</span>

    <span class="c1"># Check in project directory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/Users/srvo/dewey/dewey.yaml&quot;</span><span class="p">)</span>

    <span class="c1"># Check in config directory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/Users/srvo/dewey/config/dewey.yaml&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">config_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="c1"># If still not found, use default connection without config</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Warning: Could not find dewey.yaml configuration file. Using default connection.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;motherduck&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MOTHERDUCK_TOKEN&quot;</span><span class="p">)}}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">config</span></div>



<div class="viewcode-block" id="get_motherduck_connection">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.get_motherduck_connection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_motherduck_connection</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Establish connection to MotherDuck.&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MOTHERDUCK_TOKEN&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;motherduck&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;token&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;MotherDuck token not found. Set MOTHERDUCK_TOKEN environment variable or add to dewey.yaml.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Set token in environment variable first</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MOTHERDUCK_TOKEN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>

    <span class="c1"># Connect using environment token</span>
    <span class="n">connection_string</span> <span class="o">=</span> <span class="s2">&quot;md:dewey&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connection_string</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Execute test query to verify connection</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT 1&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connected to MotherDuck using connection string: </span><span class="si">{</span><span class="n">connection_string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error connecting to MotherDuck: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">return</span> <span class="n">conn</span></div>



<div class="viewcode-block" id="extract_schema">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.extract_schema">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_schema</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract schema information from MotherDuck.&quot;&quot;&quot;</span>
    <span class="c1"># Get list of tables</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SHOW TABLES&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">schema_info</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">table_row</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="n">table_row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get column information including primary key info</span>
        <span class="n">columns_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PRAGMA table_info(&#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
        <span class="n">columns_df</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">columns_query</span><span class="p">)</span><span class="o">.</span><span class="n">fetchdf</span><span class="p">()</span>

        <span class="c1"># Extract primary key columns from table_info</span>
        <span class="n">pk_columns</span> <span class="o">=</span> <span class="n">columns_df</span><span class="p">[</span><span class="n">columns_df</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Get foreign key information</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fk_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PRAGMA foreign_key_list(&#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
            <span class="n">foreign_keys_df</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">fk_query</span><span class="p">)</span><span class="o">.</span><span class="n">fetchdf</span><span class="p">()</span>
            <span class="n">foreign_keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">foreign_keys_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">foreign_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;column&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;ref_table&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;ref_column&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Some tables might not support foreign key info</span>
            <span class="n">foreign_keys</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process columns</span>
        <span class="n">column_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">is_nullable</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;notnull&quot;</span><span class="p">]</span>
            <span class="n">default_value</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;dflt_value&quot;</span><span class="p">]</span>
            <span class="n">is_pk</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>

            <span class="n">column_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">col_name</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">col_type</span><span class="p">,</span>
                    <span class="s2">&quot;nullable&quot;</span><span class="p">:</span> <span class="n">is_nullable</span><span class="p">,</span>
                    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">default_value</span><span class="p">,</span>
                    <span class="s2">&quot;primary_key&quot;</span><span class="p">:</span> <span class="n">is_pk</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="n">schema_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;table_name&quot;</span><span class="p">:</span> <span class="n">table_name</span><span class="p">,</span>
                <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">column_info</span><span class="p">,</span>
                <span class="s2">&quot;foreign_keys&quot;</span><span class="p">:</span> <span class="n">foreign_keys</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">schema_info</span></div>



<div class="viewcode-block" id="map_duckdb_to_sqlalchemy">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.map_duckdb_to_sqlalchemy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">map_duckdb_to_sqlalchemy</span><span class="p">(</span><span class="n">duckdb_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Map DuckDB data types to SQLAlchemy types.&quot;&quot;&quot;</span>
    <span class="c1"># Extract the base type without precision or scale</span>
    <span class="n">base_type</span> <span class="o">=</span> <span class="n">duckdb_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">DUCKDB_TO_SQLALCHEMY_TYPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_type</span><span class="p">,</span> <span class="s2">&quot;sa.String&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_existing_models">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.parse_existing_models">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_existing_models</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse existing model file to extract custom methods.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">current_model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">in_method</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">current_method</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">indentation</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
        <span class="c1"># Check if this is a class definition</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;class &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;(Base)&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;class &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">current_model</span> <span class="o">=</span> <span class="n">class_name</span>
            <span class="n">models</span><span class="p">[</span><span class="n">current_model</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="n">in_method</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">indentation</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>

        <span class="c1"># Check if we&#39;re in a method</span>
        <span class="k">elif</span> <span class="n">current_model</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;def &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># This is a method definition</span>
            <span class="k">if</span> <span class="n">in_method</span> <span class="ow">and</span> <span class="n">current_method</span><span class="p">:</span>
                <span class="c1"># Save the previous method</span>
                <span class="n">models</span><span class="p">[</span><span class="n">current_model</span><span class="p">][</span><span class="s2">&quot;methods&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_method</span><span class="p">)</span>

            <span class="n">current_method</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>
            <span class="n">in_method</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">method_indent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>

        <span class="c1"># If we&#39;re in a method, collect its lines</span>
        <span class="k">elif</span> <span class="n">in_method</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">method_indent</span><span class="p">:</span>
                <span class="n">current_method</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Method ended</span>
                <span class="n">models</span><span class="p">[</span><span class="n">current_model</span><span class="p">][</span><span class="s2">&quot;methods&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_method</span><span class="p">)</span>
                <span class="n">current_method</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">in_method</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Check if this is a new method</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;def &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">current_method</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>
                    <span class="n">in_method</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">method_indent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>

    <span class="c1"># Save the last method if there is one</span>
    <span class="k">if</span> <span class="n">in_method</span> <span class="ow">and</span> <span class="n">current_method</span><span class="p">:</span>
        <span class="n">models</span><span class="p">[</span><span class="n">current_model</span><span class="p">][</span><span class="s2">&quot;methods&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_method</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">models</span></div>



<div class="viewcode-block" id="generate_sql_schemas_and_indexes">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.generate_sql_schemas_and_indexes">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_sql_schemas_and_indexes</span><span class="p">(</span>
    <span class="n">schema_info</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate SQL schemas and indexes for all tables.&quot;&quot;&quot;</span>
    <span class="c1"># SQL reserved keywords that need to be escaped</span>
    <span class="n">SQL_RESERVED</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;from&quot;</span><span class="p">,</span>
        <span class="s2">&quot;where&quot;</span><span class="p">,</span>
        <span class="s2">&quot;select&quot;</span><span class="p">,</span>
        <span class="s2">&quot;insert&quot;</span><span class="p">,</span>
        <span class="s2">&quot;update&quot;</span><span class="p">,</span>
        <span class="s2">&quot;delete&quot;</span><span class="p">,</span>
        <span class="s2">&quot;drop&quot;</span><span class="p">,</span>
        <span class="s2">&quot;create&quot;</span><span class="p">,</span>
        <span class="s2">&quot;alter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;table&quot;</span><span class="p">,</span>
        <span class="s2">&quot;index&quot;</span><span class="p">,</span>
        <span class="s2">&quot;view&quot;</span><span class="p">,</span>
        <span class="s2">&quot;order&quot;</span><span class="p">,</span>
        <span class="s2">&quot;by&quot;</span><span class="p">,</span>
        <span class="s2">&quot;group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;having&quot;</span><span class="p">,</span>
        <span class="s2">&quot;limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;offset&quot;</span><span class="p">,</span>
        <span class="s2">&quot;join&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inner&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="s2">&quot;on&quot;</span><span class="p">,</span>
        <span class="s2">&quot;as&quot;</span><span class="p">,</span>
        <span class="s2">&quot;case&quot;</span><span class="p">,</span>
        <span class="s2">&quot;when&quot;</span><span class="p">,</span>
        <span class="s2">&quot;then&quot;</span><span class="p">,</span>
        <span class="s2">&quot;else&quot;</span><span class="p">,</span>
        <span class="s2">&quot;end&quot;</span><span class="p">,</span>
        <span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">,</span>
        <span class="s2">&quot;grant&quot;</span><span class="p">,</span>
        <span class="s2">&quot;revoke&quot;</span><span class="p">,</span>
        <span class="s2">&quot;commit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rollback&quot;</span><span class="p">,</span>
        <span class="s2">&quot;between&quot;</span><span class="p">,</span>
        <span class="s2">&quot;like&quot;</span><span class="p">,</span>
        <span class="s2">&quot;in&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exists&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Function to escape column names</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">escape_column</span><span class="p">(</span><span class="n">col_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">SQL_RESERVED</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="k">return</span> <span class="n">col_name</span>

    <span class="n">schemas</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">schema_info</span><span class="p">:</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span>

        <span class="c1"># Generate CREATE TABLE statement</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]:</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Escape column name if it&#39;s a reserved keyword</span>
            <span class="n">escaped_col_name</span> <span class="o">=</span> <span class="n">escape_column</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;nullable&quot;</span><span class="p">]:</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;NOT NULL&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;primary_key&quot;</span><span class="p">]:</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;PRIMARY KEY&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEFAULT </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">col_def</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">escaped_col_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">col_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_def</span><span class="p">)</span>

        <span class="c1"># Add foreign key constraints</span>
        <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;foreign_keys&quot;</span><span class="p">]:</span>
            <span class="n">escaped_col</span> <span class="o">=</span> <span class="n">escape_column</span><span class="p">(</span><span class="n">fk</span><span class="p">[</span><span class="s2">&quot;column&quot;</span><span class="p">])</span>
            <span class="n">escaped_ref_col</span> <span class="o">=</span> <span class="n">escape_column</span><span class="p">(</span><span class="n">fk</span><span class="p">[</span><span class="s2">&quot;ref_column&quot;</span><span class="p">])</span>
            <span class="n">fk_constraint</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;FOREIGN KEY (</span><span class="si">{</span><span class="n">escaped_col</span><span class="si">}</span><span class="s2">) REFERENCES </span><span class="si">{</span><span class="n">fk</span><span class="p">[</span><span class="s1">&#39;ref_table&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">escaped_ref_col</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fk_constraint</span><span class="p">)</span>

        <span class="n">create_table</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;CREATE TABLE IF NOT EXISTS </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span><span class="se">\n</span><span class="s2">    &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="n">schemas</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_table</span>

        <span class="c1"># Generate indexes - we&#39;ll create simple indexes for all columns that are primary keys</span>
        <span class="n">table_indexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;primary_key&quot;</span><span class="p">]:</span>
                <span class="n">idx_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;idx_</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">escaped_col</span> <span class="o">=</span> <span class="n">escape_column</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="n">index_sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CREATE INDEX IF NOT EXISTS </span><span class="si">{</span><span class="n">idx_name</span><span class="si">}</span><span class="s2"> ON </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">escaped_col</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="n">table_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_sql</span><span class="p">)</span>

        <span class="c1"># Add more indexes based on foreign keys</span>
        <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;foreign_keys&quot;</span><span class="p">]:</span>
            <span class="n">idx_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;idx_</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fk</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">escaped_col</span> <span class="o">=</span> <span class="n">escape_column</span><span class="p">(</span><span class="n">fk</span><span class="p">[</span><span class="s2">&quot;column&quot;</span><span class="p">])</span>
            <span class="n">index_sql</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;CREATE INDEX IF NOT EXISTS </span><span class="si">{</span><span class="n">idx_name</span><span class="si">}</span><span class="s2"> ON </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">escaped_col</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="n">table_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_sql</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">table_indexes</span><span class="p">:</span>
            <span class="n">indexes</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_indexes</span>

    <span class="k">return</span> <span class="n">schemas</span><span class="p">,</span> <span class="n">indexes</span></div>



<div class="viewcode-block" id="generate_sqlalchemy_models">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.generate_sqlalchemy_models">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_sqlalchemy_models</span><span class="p">(</span>
    <span class="n">schema_info</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">existing_models</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">add_primary_key_if_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate SQLAlchemy model classes from schema information.&quot;&quot;&quot;</span>
    <span class="c1"># Generate SQL schemas and indexes</span>
    <span class="n">sql_schemas</span><span class="p">,</span> <span class="n">sql_indexes</span> <span class="o">=</span> <span class="n">generate_sql_schemas_and_indexes</span><span class="p">(</span><span class="n">schema_info</span><span class="p">)</span>

    <span class="n">imports</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;import sqlalchemy as sa&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from sqlalchemy.ext.declarative import declarative_base&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from sqlalchemy import Column&quot;</span><span class="p">,</span>  <span class="c1"># Add explicit Column import</span>
        <span class="s2">&quot;from sqlalchemy.orm import relationship&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from datetime import datetime, date, time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from typing import Optional, List, Dict, Any&quot;</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Base = declarative_base()&quot;</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">model_definitions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">schema_info</span><span class="p">:</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span>

        <span class="n">model_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;class </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">(Base):&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;    __tablename__ = &#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Check if table has a primary key defined</span>
        <span class="n">has_primary_key</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="s2">&quot;primary_key&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">])</span>

        <span class="c1"># Add columns</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]:</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="n">sanitize_identifier</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>  <span class="c1"># Sanitize column name</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="n">map_duckdb_to_sqlalchemy</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>

            <span class="c1"># Build column options</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;primary_key&quot;</span><span class="p">]:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;primary_key=True&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;nullable&quot;</span><span class="p">]:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;nullable=False&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># For default values, need to handle different types</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">):</span>
                        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;default=</span><span class="si">{</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">column</span><span class="p">[</span>
                        <span class="s2">&quot;default&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
                        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;default=</span><span class="si">{</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;default=&#39;</span><span class="si">{</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;default=</span><span class="si">{</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Check if it&#39;s a foreign key</span>
            <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;foreign_keys&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">fk</span><span class="p">[</span><span class="s2">&quot;column&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;sa.ForeignKey(&#39;</span><span class="si">{</span><span class="n">fk</span><span class="p">[</span><span class="s1">&#39;ref_table&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fk</span><span class="p">[</span><span class="s1">&#39;ref_column&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Combine options</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
                <span class="n">col_def</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2"> = Column(</span><span class="si">{</span><span class="n">col_type</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col_def</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2"> = Column(</span><span class="si">{</span><span class="n">col_type</span><span class="si">}</span><span class="s2">)&quot;</span>

            <span class="n">model_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_def</span><span class="p">)</span>

        <span class="c1"># Add a primary key if missing and requested</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_primary_key</span> <span class="ow">and</span> <span class="n">add_primary_key_if_missing</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]):</span>
                <span class="c1"># Table has id but not marked as primary key</span>
                <span class="n">id_col</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span><span class="p">)</span>
                <span class="n">id_type</span> <span class="o">=</span> <span class="n">map_duckdb_to_sqlalchemy</span><span class="p">(</span><span class="n">id_col</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
                <span class="n">model_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;    # SQLAlchemy workaround: Adding primary key to id column&quot;</span>
                <span class="p">)</span>
                <span class="n">model_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    id = Column(</span><span class="si">{</span><span class="n">id_type</span><span class="si">}</span><span class="s2">, primary_key=True)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Table has no id column, add a virtual one for SQLAlchemy</span>
                <span class="n">model_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;    # SQLAlchemy workaround: Adding virtual primary key&quot;</span>
                <span class="p">)</span>
                <span class="n">model_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    id = Column(sa.Integer, primary_key=True)&quot;</span><span class="p">)</span>
                <span class="n">model_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    __mapper_args__ = {&#39;primary_key&#39;: [&#39;id&#39;]}&quot;</span><span class="p">)</span>
                <span class="n">model_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;    # Note: This column doesn&#39;t exist in the database&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Add custom methods from existing model</span>
        <span class="k">if</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">existing_models</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">existing_models</span><span class="p">[</span><span class="n">class_name</span><span class="p">][</span><span class="s2">&quot;methods&quot;</span><span class="p">]:</span>
                <span class="n">model_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">method</span><span class="p">])</span>

        <span class="n">model_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Add a blank line after class</span>
        <span class="n">model_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_lines</span><span class="p">))</span>

    <span class="c1"># Add TABLE_SCHEMAS and TABLE_INDEXES</span>
    <span class="n">table_schemas_dict</span> <span class="o">=</span> <span class="s2">&quot;TABLE_SCHEMAS = {</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">sql_schemas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Escape single quotes in the schema</span>
        <span class="n">escaped_schema</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">table_schemas_dict</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    &#39;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&#39;: &#39;&#39;&#39;</span><span class="si">{</span><span class="n">escaped_schema</span><span class="si">}</span><span class="s2">&#39;&#39;&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_schemas_dict</span> <span class="o">+=</span> <span class="s2">&quot;}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

    <span class="n">table_indexes_dict</span> <span class="o">=</span> <span class="s2">&quot;TABLE_INDEXES = {</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">indexes_list</span> <span class="ow">in</span> <span class="n">sql_indexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">table_indexes_dict</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    &#39;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&#39;: [</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes_list</span><span class="p">:</span>
            <span class="c1"># Escape single quotes in the index</span>
            <span class="n">escaped_index</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">table_indexes_dict</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &#39;&#39;&#39;</span><span class="si">{</span><span class="n">escaped_index</span><span class="si">}</span><span class="s2">&#39;&#39;&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">table_indexes_dict</span> <span class="o">+=</span> <span class="s2">&quot;    ],</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">table_indexes_dict</span> <span class="o">+=</span> <span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># Combine everything</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">imports</span> <span class="o">+</span> <span class="n">model_definitions</span> <span class="o">+</span> <span class="p">[</span><span class="n">table_schemas_dict</span><span class="p">,</span> <span class="n">table_indexes_dict</span><span class="p">]</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="parse_create_table_schema">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.parse_create_table_schema">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_create_table_schema</span><span class="p">(</span><span class="n">schema_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse a CREATE TABLE schema string into a dictionary of column definitions.</span>

<span class="sd">    Args:</span>
<span class="sd">        schema_str: CREATE TABLE SQL statement</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping column names to their properties</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract table name and columns</span>
    <span class="n">table_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;CREATE TABLE\s+(?:IF NOT EXISTS\s+)?(\w+)\s*\((.*?)\)&quot;</span><span class="p">,</span> <span class="n">schema_str</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">table_match</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid CREATE TABLE statement: </span><span class="si">{</span><span class="n">schema_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">table_name</span> <span class="o">=</span> <span class="n">table_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">columns_str</span> <span class="o">=</span> <span class="n">table_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Split into individual column definitions</span>
    <span class="n">column_defs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_def</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">paren_level</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">columns_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Count parentheses to handle nested definitions</span>
        <span class="n">paren_level</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_def</span><span class="p">:</span>
            <span class="n">current_def</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_def</span> <span class="o">=</span> <span class="n">line</span>

        <span class="c1"># If the definition is complete</span>
        <span class="k">if</span> <span class="n">paren_level</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="n">columns_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_def</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
            <span class="n">current_def</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Process column definitions</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">def_str</span> <span class="ow">in</span> <span class="n">column_defs</span><span class="p">:</span>
        <span class="c1"># Skip constraints not related to columns</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">def_str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;CONSTRAINT&quot;</span><span class="p">,</span> <span class="s2">&quot;PRIMARY KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;FOREIGN KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;UNIQUE&quot;</span><span class="p">,</span> <span class="s2">&quot;CHECK&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Extract column name (handling quoted identifiers)</span>
        <span class="n">name_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?:&quot;([^&quot;]+)&quot;|(\w+))\s+(\w+)&#39;</span><span class="p">,</span> <span class="n">def_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name_match</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">col_name</span> <span class="o">=</span> <span class="n">name_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">col_type</span> <span class="o">=</span> <span class="n">name_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Determine column properties</span>
        <span class="n">not_null</span> <span class="o">=</span> <span class="s2">&quot;NOT NULL&quot;</span> <span class="ow">in</span> <span class="n">def_str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">primary_key</span> <span class="o">=</span> <span class="s2">&quot;PRIMARY KEY&quot;</span> <span class="ow">in</span> <span class="n">def_str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">default_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;DEFAULT\s+([^,\s]+)&quot;</span><span class="p">,</span> <span class="n">def_str</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default_match</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">default_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">columns</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">col_type</span><span class="p">,</span>
            <span class="s2">&quot;nullable&quot;</span><span class="p">:</span> <span class="ow">not</span> <span class="n">not_null</span><span class="p">,</span>
            <span class="s2">&quot;primary_key&quot;</span><span class="p">:</span> <span class="n">primary_key</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">default</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;table_name&quot;</span><span class="p">:</span> <span class="n">table_name</span><span class="p">,</span> <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">columns</span><span class="p">}</span></div>



<div class="viewcode-block" id="compare_schemas_and_generate_alters">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.compare_schemas_and_generate_alters">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compare_schemas_and_generate_alters</span><span class="p">(</span>
    <span class="n">db_schema</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">code_schemas</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare database schema with code-defined schemas and generate ALTER statements.</span>

<span class="sd">    Args:</span>
<span class="sd">        db_schema: Schema extracted from the database</span>
<span class="sd">        code_schemas: Schemas defined in code (parsed from CREATE TABLE statements)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping table names to lists of ALTER statements</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alter_statements</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Process each table from code schemas</span>
    <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">code_schema</span> <span class="ow">in</span> <span class="n">code_schemas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Find matching table in DB schema</span>
        <span class="n">db_table</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">db_schema</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">table_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">db_table</span><span class="p">:</span>
            <span class="c1"># Table exists, check columns</span>
            <span class="n">db_columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">db_table</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]}</span>
            <span class="n">code_columns</span> <span class="o">=</span> <span class="n">code_schema</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span>

            <span class="c1"># Find columns in code but not in DB</span>
            <span class="n">missing_columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_info</span> <span class="ow">in</span> <span class="n">code_columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">col_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">db_columns</span><span class="p">:</span>
                    <span class="n">missing_columns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col_name</span><span class="p">,</span> <span class="n">col_info</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
                <span class="n">alter_statements</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># Generate ALTER TABLE statements for each missing column</span>
                <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_info</span> <span class="ow">in</span> <span class="n">missing_columns</span><span class="p">:</span>
                    <span class="c1"># Build column definition</span>
                    <span class="n">col_def</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">col_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">col_info</span><span class="p">[</span><span class="s2">&quot;nullable&quot;</span><span class="p">]:</span>
                        <span class="n">col_def</span> <span class="o">+=</span> <span class="s2">&quot; NOT NULL&quot;</span>

                    <span class="k">if</span> <span class="n">col_info</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">col_def</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; DEFAULT </span><span class="si">{</span><span class="n">col_info</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="n">alter_statements</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;ALTER TABLE </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> ADD COLUMN </span><span class="si">{</span><span class="n">col_def</span><span class="si">}</span><span class="s2">;&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Table doesn&#39;t exist, generate CREATE TABLE</span>
            <span class="c1"># Extract full CREATE TABLE statement from the original schema</span>
            <span class="c1"># This assumes you have access to the original CREATE TABLE statements</span>
            <span class="c1"># You might need to adapt this based on how you store/access the schemas</span>
            <span class="n">alter_statements</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;-- Table </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> doesn&#39;t exist in the database&quot;</span>
                <span class="c1"># Add CREATE TABLE statement if you have it</span>
            <span class="p">]</span>

    <span class="k">return</span> <span class="n">alter_statements</span></div>



<div class="viewcode-block" id="bidirectional_sync">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.bidirectional_sync">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bidirectional_sync</span><span class="p">(</span>
    <span class="n">conn</span><span class="p">:</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">,</span>
    <span class="n">schema_info</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">code_schemas</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="n">execute_alters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform bidirectional synchronization between database and code.</span>

<span class="sd">    Args:</span>
<span class="sd">        conn: Database connection</span>
<span class="sd">        schema_info: Schema extracted from database</span>
<span class="sd">        code_schemas: Schemas defined in code</span>
<span class="sd">        execute_alters: Whether to execute the ALTER statements</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary of ALTER statements (executed or not)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate ALTER statements</span>
    <span class="n">alter_statements</span> <span class="o">=</span> <span class="n">compare_schemas_and_generate_alters</span><span class="p">(</span><span class="n">schema_info</span><span class="p">,</span> <span class="n">code_schemas</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">alter_statements</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No schema changes needed. Database schema matches code-defined schemas.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="c1"># Print ALTER statements</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated ALTER statements for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">alter_statements</span><span class="p">)</span><span class="si">}</span><span class="s2"> tables:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">statements</span> <span class="ow">in</span> <span class="n">alter_statements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Table: </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">stmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Execute ALTER statements if requested</span>
    <span class="k">if</span> <span class="n">execute_alters</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Executing ALTER statements...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">statements</span> <span class="ow">in</span> <span class="n">alter_statements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Executed: </span><span class="si">{</span><span class="n">stmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Error executing </span><span class="si">{</span><span class="n">stmt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alter_statements</span></div>



<div class="viewcode-block" id="extract_schema_from_code">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.extract_schema_from_code">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_schema_from_code</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract schemas defined in code from various modules.&quot;&quot;&quot;</span>
    <span class="n">schemas</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># You&#39;ll need to identify and locate all schema definitions in your code</span>
    <span class="c1"># This is just an example - adapt it to your project structure</span>
    <span class="n">email_schema_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
        <span class="s2">&quot;/Users/srvo/dewey/src/dewey/core/crm/email/imap_import_standalone.py&quot;</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># This is a simplistic approach - in a real app you might need a more robust solution</span>
        <span class="c1"># like importing the modules and accessing their schema attributes</span>
        <span class="k">if</span> <span class="n">email_schema_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">email_schema_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1"># Extract EMAIL_SCHEMA using regex</span>
                <span class="n">schema_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">&quot;EMAIL_SCHEMA\s*=\s*\&#39;\&#39;\&#39;(.*?)\&#39;\&#39;\&#39;&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">schema_match</span><span class="p">:</span>
                    <span class="n">email_schema</span> <span class="o">=</span> <span class="n">schema_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">schema_info</span> <span class="o">=</span> <span class="n">parse_create_table_schema</span><span class="p">(</span><span class="n">email_schema</span><span class="p">)</span>
                    <span class="n">schemas</span><span class="p">[</span><span class="n">schema_info</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">schema_info</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting schema from </span><span class="si">{</span><span class="n">email_schema_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">schemas</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../../dewey.core.db.html#dewey.core.db.schema_updater.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span>
    <span class="n">force_imports</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">add_primary_key_if_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">sync_to_db</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">execute_alters</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main function to extract schema and generate models.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load configuration</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">()</span>

        <span class="c1"># Connect to MotherDuck</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">get_motherduck_connection</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Extract schema from database</span>
        <span class="n">schema_info</span> <span class="o">=</span> <span class="n">extract_schema</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Extracted schema information for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">schema_info</span><span class="p">)</span><span class="si">}</span><span class="s2"> tables from database.&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">sync_to_db</span><span class="p">:</span>
            <span class="c1"># Extract schemas defined in code</span>
            <span class="n">code_schemas</span> <span class="o">=</span> <span class="n">extract_schema_from_code</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">code_schemas</span><span class="p">)</span><span class="si">}</span><span class="s2"> schemas defined in code.&quot;</span><span class="p">)</span>

            <span class="c1"># Perform bidirectional sync</span>
            <span class="n">alter_statements</span> <span class="o">=</span> <span class="n">bidirectional_sync</span><span class="p">(</span>
                <span class="n">conn</span><span class="p">,</span> <span class="n">schema_info</span><span class="p">,</span> <span class="n">code_schemas</span><span class="p">,</span> <span class="n">execute_alters</span>
            <span class="p">)</span>

            <span class="c1"># Re-extract schema if we executed alters</span>
            <span class="k">if</span> <span class="n">execute_alters</span> <span class="ow">and</span> <span class="n">alter_statements</span><span class="p">:</span>
                <span class="n">schema_info</span> <span class="o">=</span> <span class="n">extract_schema</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Re-extracted schema after alterations for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">schema_info</span><span class="p">)</span><span class="si">}</span><span class="s2"> tables.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Output file path</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/Users/srvo/dewey/src/dewey/core/db&quot;</span><span class="p">)</span>
        <span class="n">models_file</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;models.py&quot;</span>

        <span class="c1"># Parse existing models</span>
        <span class="n">existing_models</span> <span class="o">=</span> <span class="n">parse_existing_models</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">models_file</span><span class="p">))</span>

        <span class="c1"># Create backup</span>
        <span class="k">if</span> <span class="n">models_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">backup_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">models_file</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.bak&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">models_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">backup_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created backup of existing models file at </span><span class="si">{</span><span class="n">backup_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Generate SQLAlchemy models</span>
        <span class="n">model_code</span> <span class="o">=</span> <span class="n">generate_sqlalchemy_models</span><span class="p">(</span>
            <span class="n">schema_info</span><span class="p">,</span> <span class="n">existing_models</span><span class="p">,</span> <span class="n">add_primary_key_if_missing</span>
        <span class="p">)</span>

        <span class="c1"># Write to file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">models_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">model_code</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated models file at </span><span class="si">{</span><span class="n">models_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Format the file with Black</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;--target-version&quot;</span><span class="p">,</span> <span class="s2">&quot;py311&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">models_file</span><span class="p">)],</span>
                <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successfully formatted the generated file with Black.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning: Formatting with Black failed: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning: Black formatter not found. Install with &#39;pip install black&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Schema extraction and model updates completed successfully.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="mi">0</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Update SQLAlchemy models from MotherDuck schema.&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--force_imports&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Force adding imports even if they might already exist.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_primary_key_workaround&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;add_primary_key&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable adding virtual primary keys for tables without them.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--sync_to_db&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Synchronize database schema with schemas defined in code.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--execute_alters&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Execute ALTER statements to update database schema (use with --sync_to_db).&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
        <span class="n">main</span><span class="p">(</span>
            <span class="n">force_imports</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">force_imports</span><span class="p">,</span>
            <span class="n">add_primary_key_if_missing</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">add_primary_key</span><span class="p">,</span>
            <span class="n">sync_to_db</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sync_to_db</span><span class="p">,</span>
            <span class="n">execute_alters</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">execute_alters</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">Dewey (TUI)</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">dewey</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  <li><a href="../../../dewey.html">dewey</a><ul>
  <li><a href="../db.html">dewey.core.db</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Sloane Ortel.

      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>

    </div>




  </body>
</html>
